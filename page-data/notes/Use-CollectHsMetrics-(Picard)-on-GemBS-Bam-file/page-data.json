{
    "componentChunkName": "component---src-templates-note-template-js",
    "path": "/notes/Use-CollectHsMetrics-(Picard)-on-GemBS-Bam-file",
    "result": {"data":{"markdownRemark":{"html":"<p>The task here is to run Picard tool <a href=\"https://gatk.broadinstitute.org/hc/en-us/articles/360036856051-CollectHsMetrics-Picard-\">CollectHsMetrics</a>, initially it’s not working, after long time debug, I eventually found the error was caused by different MD5 in head tag.</p>\n<h2>1. Prepare dict file for reference with CreateSequenceDictionary (Picard)</h2>\n<p>To run CollectHsMetrics, the first step is to create a reference.dict for the reference used for fastq-2-bam alignment. The code is below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java -jar picard.jar CreateSequenceDictionary -R hg38.fa -O hg38.dict\n</code></pre></div>\n<p>After above command, a <code class=\"language-text\">hg38.dict</code> file will be created in the current folder. It looks like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tian@slms-ci-beck-02 /scratch1/Tian/Cansor/EMseq/13.PicardHSMetric $ head hg38.dict\n@HD\tVN:1.6\n**@SQ\tSN:chr1\tLN:248956422\tM5:2648ae1bacce4ec4b6cf337dcae37816\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz**\n@SQ\tSN:chr10\tLN:133797422\tM5:907112d17fcb73bcab1ed1c72b97ce68\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr11\tLN:135086622\tM5:1511375dc2dd1b633af8cf439ae90cec\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr11_KI270721v1_random\tLN:100316\tM5:9654b5d3f36845bb9d19a6dbd15d2f22\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr12\tLN:133275309\tM5:e81e16d3f44337034695a29b97708fce\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr13\tLN:114364328\tM5:17dab79b963ccd8e7377cef59a54fe1c\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr14\tLN:107043718\tM5:acbd9552c059d9b403e75ed26c1ce5bc\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr14_GL000009v2_random\tLN:201709\tM5:862f555045546733591ff7ab15bcecbe\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n@SQ\tSN:chr14_GL000225v1_random\tLN:211173\tM5:63945c3e6962f28ffd469719a747e73c\tUR:file:/scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/hg38.fa.gz\n</code></pre></div>\n<p>Then use this file to create interval with Twist target regions.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java -jar picard.jar BedToIntervalList I=Covered_Targets_Twist_Methylome_V1_hg38.txt  O=Twist.interval_list SD=hg38.replaced.dict\n</code></pre></div>\n<p>However, after this step, the standard picard function is not working, after a long time search, I found the problem is MD5.</p>\n<h2>2. Problem happen: Different MD5 between methods</h2>\n<p>When I check the bam files’ head tag. The M5 is different:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tian@slms-ci-beck-02 /scratch1/Tian/Cansor/EMseq/2.GemBS_Analysis/Compare3Set/mapping/J080001 $ samtools view -H J080001.bam | head\n@HD\tVN:1.4\tSO:coordinate\n**@SQ\tSN:chr1\tLN:248956422\tM5:a004bc1b0bf05fc668cab6bbfd93d3eb**\n@SQ\tSN:chr10\tLN:133797422\tM5:6b420cbb22daea77d7cc930c0a00f812\n@SQ\tSN:chr11\tLN:135086622\tM5:0d4e0be5c4e5bc0f12912894f21a5dd8\n@SQ\tSN:chr11_KI270721v1_random\tLN:100316\tM5:e3075f8f08d2f270b013932f76fbe247\n@SQ\tSN:chr12\tLN:133275309\tM5:e1507ba70028a65b3f5a81b594e6f0fe\n@SQ\tSN:chr13\tLN:114364328\tM5:7110500758388b169fe631b212b7e56c\n@SQ\tSN:chr14\tLN:107043718\tM5:f37e77fdbacb1a0f1be5e2bf25df343d\n@SQ\tSN:chr14_GL000009v2_random\tLN:201709\tM5:8facccfe9de958a6033a33c35ab4ebb2\n@SQ\tSN:chr14_GL000225v1_random\tLN:211173\tM5:08d9a7a0b240ed926ed17a32929b785d\n</code></pre></div>\n<p>The MD5 head of each bam file is generated by <code class=\"language-text\">hg38.gemBS.contig_md5</code> file after <code class=\"language-text\">gemBS index</code></p>\n<p>. <strong>In other word, why gemBS and Picard created different MD5 for each contig?</strong></p>\n<p>Inspired by <a href=\"https://github.com/samtools/samtools/issues/704\">this post</a>, I tested a bit, after extract a short contig chrUn_KI270373v1 from hg38.fa. Then create a new <code class=\"language-text\">test.fa</code> as below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">>chrUn_KI270373v1\naaaactagacagaagcattctcagaagcgactttgtgatgtgtgcattct\nactcccatagttgaacctttcttttgatagagcagtctggaaacactctt\ntttgtcgaatctgcaaatggacttttggagcgctttgaaggctatggtgg\naaaaggaaatatcttcacataaaaactagacggaagcattctcagaaact\ntctttgtgttgtgttcattcaactcacatagttgaactttacttttgata\ngagcagtttggaagcccttttttattaagtctgcaggaggatatttggag\nctctttgaatccttcgttggaaacgggaatagcttcatataaatactaga\naagaagcattctcagaaaccactttgtgatgtgtgcattcaactcacaca\ngttgaaccttccttttgatagagcagtttggaaacactctttttgtagaa\ntgtgcatgtagatatttgtagcgaatagaagccttcgtttgaaataggaa\ntatcttcacctaaaaactagatggaagcattgtcagaaagtcctttgtga\ntgtgtgcattcaactcacagaactgaaccttccttcagatagagaagttt\ntgaaacactctttttgtagaatctgcatttacatctttggagcgctttga\nagtcttcgttggaaacgcaaataccttcacataaaaaatagacggagcca\nttctcagaaaattatttgtgatgtgtgcattcaactcacagagttgaacc\natctttttgatagagcagttttgaaacagtctttttgtagaatctggagg\ncgcatatttagagcgctttgaagccttccttggaaatgggattatcttca\ncataaaaactagacagctttctacatatggctagtcagttttcccagcac\ncatttattaaagagggaatcctttccccattgcttgtttttctcaggttt\ngtcaaagatcagatagttgtagatatgcggcgttatttctgagggctctg\nttctgttccgttgatctatatctctgttttggtaccagtaccatgctgtt\nttggttactggaaccttgtagtatagtttgaagtcaggtagtgtgatgcc\ntccagctttgttcttttggcttaggattgacttggtgatgcgggctcttt\ntttggttccatatgaactttaaagtagcttttccaattctgtgaagaaag\ngcattggtagcttgatggggatggcactgaatctgcaaattaccttgggc\nagtatggccattttcacgatattgattcttcctacccatgagcgtgggaa\ntgttcttccatttgtttgtatcctcttttatttccttgagtagttggttt\ngtagttctctttgaaagaggtccttcacatccctttgtaggttggattcc\ntaggtattttattctctttgaagcaattgtgaatggggagttcactcatg\na\n</code></pre></div>\n<p>Then I manually created the MD5 by reading the string into R.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">> contig &lt;- read.table(\"test.fa\", skip=1)\n> contig &lt;- paste0(contig[,1], collapse=\"\")\n> contig\n[1] \"aaaactagacagaagcattctcagaagcgactttgtgatgtgtgcattctactcccatagttgaacctttcttttgatagagcagtctggaaacactctttttgtcgaatctgcaaatggacttttggagcgctttgaaggctatggtggaaaaggaaatatcttcacataaaaactagacggaagcattctcagaaacttctttgtgttgtgttcattcaactcacatagttgaactttacttttgatagagcagtttggaagcccttttttattaagtctgcaggaggatatttggagctctttgaatccttcgttggaaacgggaatagcttcatataaatactagaaagaagcattctcagaaaccactttgtgatgtgtgcattcaactcacacagttgaaccttccttttgatagagcagtttggaaacactctttttgtagaatgtgcatgtagatatttgtagcgaatagaagccttcgtttgaaataggaatatcttcacctaaaaactagatggaagcattgtcagaaagtcctttgtgatgtgtgcattcaactcacagaactgaaccttccttcagatagagaagttttgaaacactctttttgtagaatctgcatttacatctttggagcgctttgaagtcttcgttggaaacgcaaataccttcacataaaaaatagacggagccattctcagaaaattatttgtgatgtgtgcattcaactcacagagttgaaccatctttttgatagagcagttttgaaacagtctttttgtagaatctggaggcgcatatttagagcgctttgaagccttccttggaaatgggattatcttcacataaaaactagacagctttctacatatggctagtcagttttcccagcaccatttattaaagagggaatcctttccccattgcttgtttttctcaggtttgtcaaagatcagatagttgtagatatgcggcgttatttctgagggctctgttctgttccgttgatctatatctctgttttggtaccagtaccatgctgttttggttactggaaccttgtagtatagtttgaagtcaggtagtgtgatgcctccagctttgttcttttggcttaggattgacttggtgatgcgggctcttttttggttccatatgaactttaaagtagcttttccaattctgtgaagaaaggcattggtagcttgatggggatggcactgaatctgcaaattaccttgggcagtatggccattttcacgatattgattcttcctacccatgagcgtgggaatgttcttccatttgtttgtatcctcttttatttccttgagtagttggtttgtagttctctttgaaagaggtccttcacatccctttgtaggttggattcctaggtattttattctctttgaagcaattgtgaatggggagttcactcatga\"\n>\n> library(digest)\n> digest(contig, algo=\"md5\", serialize=F)\n[1] \"8abd598da8e385b0f3c48f0b6bc9e35e\"\n>\n> digest(toupper(contig), algo=\"md5\", serialize=F) # Picard value\n[1] \"b174fe53be245a840cd6324e39b88ced\"\n>\n</code></pre></div>\n<p>The MD5 value <code class=\"language-text\">8abd598da8e385b0f3c48f0b6bc9e35e</code> is exactly the same as the value in <code class=\"language-text\">hg38.gemBS.contig_md5</code>  (below line with chrUn_KI270373v1 start).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># hg38.gemBS.contig_md5 file\nchrUn_KI270376v1    LN:1136 M5:afa726dc6156278c2cda16e84f532850\nchrUn_KI270374v1    LN:2656 M5:a404c1bedb4862c64d493643b3cf786f\nchrUn_KI270372v1    LN:1650 M5:2fa607121376431d2cc4ac0fbc1f6e19\nchrUn_KI270373v1    LN:1451 M5:8abd598da8e385b0f3c48f0b6bc9e35e\nchrUn_KI270375v1    LN:2378 M5:efde09db3d9e65bcf7f2336634c86213\nchrUn_KI270371v1    LN:2805 M5:a53c22fb527bcfd739209c23702ecce5\nchrUn_KI270448v1    LN:7992 M5:8fe4b9bfb278721633fe864ba564f06b\nchrUn_KI270521v1    LN:7642 M5:ef22c3c4cf8acf1418f3c46d082aeaaa\n</code></pre></div>\n<p>Below is Picard generated MD5</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># hg38.dict generated from Picard\n@SQ SN:chrUn_KI270374v1 LN:2656 M5:dbc92c9a92e558946e58b4909ec95dd5 UR:file:///mnt/scratch_ssd/Tian/Cansor/EMseq/13.PicardHSMetric/hg38.fa.gz\n@SQ SN:chrUn_KI270372v1 LN:1650 M5:53a9d5e8fd28bce5da5efcfd9114dbf2 UR:file:///mnt/scratch_ssd/Tian/Cansor/EMseq/13.PicardHSMetric/hg38.fa.gz\n@SQ SN:chrUn_KI270373v1 LN:1451 M5:b174fe53be245a840cd6324e39b88ced UR:file:///mnt/scratch_ssd/Tian/Cansor/EMseq/13.PicardHSMetric/hg38.fa.gz\n@SQ SN:chrUn_KI270375v1 LN:2378 M5:d678250c97e9b94aa390fa46e70a6d83 UR:file:///mnt/scratch_ssd/Tian/Cansor/EMseq/13.PicardHSMetric/hg38.fa.gz\n@SQ SN:chrUn_KI270371v1 LN:2805 M5:a0af3d778dfeb7963e8e6d84c0c54fba UR:file:///mnt/scratch_ssd/Tian/Cansor/EMseq/13.PicardHSMetric/hg38.fa.gz\n@SQ SN:chrUn_KI270448v1 LN:7992 M5:0f40827c265cb813b6e723da6c9b926b UR:file:///mnt/scratch_ssd/Tian/Cansor/EMseq/13.PicardHSMetric/hg38.fa.gz\n</code></pre></div>\n<p>While the second MD5, generated by capital letter sequence is exactly the same as Picard. <b style=\"background-color: yellow\">In other word, Picard use capital letters for MD5, but GemBS use lowercase letters for MD5</b>.</p>\n<p>One intuitive solution is to manually write code to replace MD5 in hg38.dict with MD5 in <code class=\"language-text\">hg38.gemBS.contig_md5</code>. But this solution is not working, I tried. Because in the CollectHsMetric function, it will still re-calculate a MD5 for inputed reference. <b style=\"background-color: yellow\">So the only way I found work, is to replace whole BAM file's header MD5, with Picard generated MD5.</b>.</p>\n<h2>3. @RD Error with missing SM</h2>\n<p>Then finally we can start to run CollectHSMetric, firstly some modification need to be done with GemBS produced BAM file. There is a head tag (@RG) have empty SM value. Like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># samtools view -H J080001.bam | less\n@SQ     SN:chrUn_GL000216v2     LN:176608       M5:a44dc63aaa8abe4c33073ea553b58369\n@SQ     SN:chrUn_GL000218v1     LN:161147       M5:6179aa420feaba9a16c86dca3d051b84\n@SQ     SN:chrX LN:156040895    M5:6bdaf93397b486a58fd60b55aa2e21ca\n@SQ     SN:chrY LN:57227415     M5:9bd609da53b41a50a724f2a0131ee9c1\n@SQ     SN:chrY_KI270740v1_random       LN:37240        M5:1bccb354cf558625dbad9213faeee6ca\n@RG     ID:J080001      SM:     BC:J080001      PU:J080001\n@PG     ID:GEM  PN:gem-mapper   VN:v3.6.0-cnag-release  CL:/scratch1/Tian/Software/install/gemBS-rs/lib/gemBS/bin/gem-mapper --threads 20 -I index/hg38.BS.gem --i1 /scratch1/Tian/Cansor/EMseq/1.Fastp/JoinDataTmp/J080001_R1.fq.gz --i2 /scratch1/Tian/Cansor/EMseq/1.Fastp/JoinDataTmp/J080001_R2.fq.gz --paired-end-alignment --bisulfite-conversion inferred-C2T-G2A --report-file ./Compare3Set//mapping/J080001/J080001.json --sam-read-group-header @RG\\\\tID:J080001\\\\tSM:\\\\tBC:J080001\\\\tPU:J080001\n@PG     ID:samtools     PN:samtools     PP:GEM  VN:1.14 CL:/scratch1/Tian/Software/install/gemBS-rs/lib/gemBS/bin/samtools sort -o ./Compare3Set//mapping/J080001/J080001.bam -T ./Compare3Set//mapping/J080001 --threads 20 --write-index -\n@PG     ID:samtools.1   PN:samtools     PP:samtools     VN:1.10 CL:samtools view -H J080001.bam\n@CO     TM:2022/1/20 02:58:36 CET       WD:/mnt/scratch_ssd/Tian/Cansor/EMseq/2.GemBS_Analysis  HN:slms-ci-beck-02      UN:tian\n</code></pre></div>\n<p>Previously I thought I can remove this line, but eventually I know I can't remove it. So the way is to add a value, like <code class=\"language-text\">None</code> to after SM. Make it like. In next step I will do it after I exported the header of BAM file.</p>\n<h2>4. Edit BAM Head</h2>\n<p>Now I need to find a way to edit the head of BAM file. Replace it with picard MD5. I manually replace the first one line of MD5 in a BAM file, seems it works.</p>\n<p>Firstly I need to export the header of BAM as:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">samtools view -H J080001.bam > header.sam\n</code></pre></div>\n<p>Then replace it with Picard generated MD5, rewrite a file as <code class=\"language-text\">header.new.sam</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">samMD5 &lt;- read.csv(\"./header.sam\", header=F)\npicardMD5 &lt;- read.csv(\"./hg38.dict\", sep=\"\\\\t\", header=F)\n\nSQTag &lt;- samMD5[2:nrow(picardMD5), 1]\nSQTag &lt;- sapply(SQTag, function(x) strsplit(x, split=\"M5\")[[1]][1])\nSQTag &lt;- paste0(SQTag, picardMD5[-1, \"V4\"])\n\nsamMD5[2:nrow(picardMD5), 1] &lt;- SQTag\nwrite.table(samMD5, \"header.new.sam\", quote=F, row.names=F, col.names=F)</code></pre></div>\n<p>Now I use vim to edit the <code class=\"language-text\">header.new.sam</code> file the missing SM tag in @RG line, make it as:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">@RG     ID:J080001      SM:None     BC:J080001      PU:J080001</code></pre></div>\n<p>Then, use samtools to reset header of the bam file, like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">samtools reheader header.new.sam J080001.bam > J080001.newhead.bam\n</code></pre></div>\n<h2>5. Run CollectHsMetric</h2>\n<p>Finally, I can run this function. It requires indexed reference, so use samtools to index the <strong>unziped</strong> reference.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">samtools faidx hg38.fa</code></pre></div>\n<p>Then run comand on the modified <code class=\"language-text\">J080001.newhead.bam</code> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java -jar picard.jar CollectHsMetrics -I J080001.newhead.bam -O J080001_hs_metrics.txt -R hg38.fa -BAIT_INTERVALS Twist.interval_list -TARGET_INTERVALS Twist.interval_list -PER_TARGET_COVERAGE J080001_per_target_coverage_hs_metrics.txt -COVERAGE_CAP 1000 -NEAR_DISTANCE 500\n</code></pre></div>\n<p>Finally it works!!!</p>\n<hr>\n<h2>Summary</h2>\n<p>Honestly I am quite disappointed of this kind of work...spending days and nights on bug caused by version of software, detailed MD5 method .etc. Bioinformatic contains so many poor written software, without clear document, can't input each other easily. etc. All these \"hard work\" are useless, but necessarily need Bioinformaticians to take time and patient to debug them out...</p>\n<p>What I am even more disappointed are tons of scientific research output based on these poorly written software.</p>\n<p>I hope one day, I can open a company to provide <strong>fast, convinient, high-quality, well-documented, and completely transparently explained software</strong> for Bioinformatic research.</p>","frontmatter":{"date":"February 09, 2022","slug":"/notes/Use-CollectHsMetrics-(Picard)-on-GemBS-Bam-file","title":"Use CollectHsMetrics (Picard) on GemBS Bam file","tags":["Debug","BAM","GemBS"],"abstract":"I spend two days to make it work, running CollectHsMetrics on GemBS created BAM. The bug is created by different ways of MD5 generation. Here is a record how to make it work."}}},"pageContext":{"slug":"/notes/Use-CollectHsMetrics-(Picard)-on-GemBS-Bam-file"}},
    "staticQueryHashes": ["63159454"]}