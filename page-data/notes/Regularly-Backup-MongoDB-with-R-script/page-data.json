{
    "componentChunkName": "component---src-templates-note-template-js",
    "path": "/notes/Regularly-Backup-MongoDB-with-R-script",
    "result": {"data":{"markdownRemark":{"html":"<p>The problem I am facing is I want my GCGR website database get backup regularly. And sadly I am only good at R language.</p>\n<h3>How to run some R code regularly?</h3>\n<p>First issue I need to solve is how to run a functional regularlly? Of course a simple for/while loop should work. But I found a better solution in <a href=\"https://yihui.org/en/2017/10/later-recursion/\">Xie's blog</a>, who recommanded a package called <code class=\"language-text\">later</code>, it could delay the code a bit.</p>\n<p>For example, below hello message would be printed after 5 seconds:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">librairy<span class=\"token punctuation\">(</span><span class=\"token string\">'later'</span><span class=\"token punctuation\">)</span>\nlater<span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>cat<span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello from the past\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>So the problem is <strong>later could only run once</strong>. Xie proposed that we can employ later function inside our main function. It means, I can write my code into a function, then at the end of the function, run later on the function itself, then a time schedual would be re-arranged at each end of the program.</p>\n<p>Below is the code I write to backup my GCGR database:</p>\n<p>In below code, main backup functional code is actually bash code, I just pasted the command with a time stamp, then use <code class=\"language-text\">system</code> function to run it.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># This is a script I wrtoe to automatically backup GCGR database file into RDS and my github</span>\n<span class=\"token comment\"># Yuan Tian</span>\n\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">'later'</span><span class=\"token punctuation\">)</span>\n\nmongoBackup <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>intervel <span class=\"token operator\">=</span> <span class=\"token number\">86400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n  timeStamp <span class=\"token operator\">&lt;-</span> format<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%Y-%m-%d-%H-%M-%S\"</span><span class=\"token punctuation\">)</span>\n\n  message<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n-----------------------------\"</span><span class=\"token punctuation\">)</span>\n  message<span class=\"token punctuation\">(</span><span class=\"token string\">\"Bakckup at \"</span><span class=\"token punctuation\">,</span> timeStamp<span class=\"token punctuation\">)</span>\n  \n  backupCommand <span class=\"token operator\">&lt;-</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"mongodump --db=GCGRdb --out=./mongodump-\"</span><span class=\"token punctuation\">,</span> timeStamp<span class=\"token punctuation\">)</span>\n  system<span class=\"token punctuation\">(</span>backupCommand<span class=\"token punctuation\">)</span>\n\n  later<span class=\"token operator\">::</span>later<span class=\"token punctuation\">(</span>mongoBackup<span class=\"token punctuation\">,</span> intervel<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nmongoBackup<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>At the end of the function, a 86400 second \"delay\" would be set for set for next run.</p>\n<h3>Backup to Github</h3>\n<p>Now I can dump MongoDB file successfully. Next questions is how to store these file into another place. Firstly I would try to push them to my github. <strong>Here I need to set my vm could automatically push to github, by setting SSH key.</strong></p>\n<p>Then modify the code as:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  <span class=\"token ellipsis\">...</span>\n  system<span class=\"token punctuation\">(</span>backupCommand<span class=\"token punctuation\">)</span>\n\n  system<span class=\"token punctuation\">(</span><span class=\"token string\">'git add --all'</span><span class=\"token punctuation\">)</span>\n  system<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"git commit -m 'Backup at \"</span><span class=\"token punctuation\">,</span>timeStamp<span class=\"token punctuation\">,</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  system<span class=\"token punctuation\">(</span><span class=\"token string\">\"git push origin master\"</span><span class=\"token punctuation\">)</span>\n\n  later<span class=\"token operator\">::</span>later<span class=\"token punctuation\">(</span>mongoBackup<span class=\"token punctuation\">,</span> intervel<span class=\"token punctuation\">)</span>\n  <span class=\"token ellipsis\">...</span></code></pre></div>\n<p>The above code looks super ugly, but it really works...</p>\n<h3>Backup to RDS</h3>\n<p>Finally, I want to also backup it in the RDS. It should not be hard, and should be able to be set automatically.</p>\n<p>Firstly I installed <code class=\"language-text\">yum install sshpass</code>.</p>\n<p>Then compose below command for RDS <code class=\"language-text\">scp</code>. The code is becoming more than more ugly...</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"> system<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"sshpass -p 'myRDSpassword' scp -r ./mongodump-\"</span><span class=\"token punctuation\">,</span> timeStamp<span class=\"token punctuation\">,</span><span class=\"token string\">\" regmtyu@ssh.rd.ucl.ac.uk:/mnt/gpfs/home/regmtyu/rd00qp/GCGR_DBbackup\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Finally, I set the time as one week for one backup.</p>","frontmatter":{"date":"July 07, 2020","slug":"/notes/Regularly-Backup-MongoDB-with-R-script","title":"Regularly Backup MongoDB with R script","tags":["R","rds","Github"],"abstract":"I am maitaining the GCGR website. So I think it's a good idea to constantly backup the database a bit. So my idea is to regularlly run some R code (because I only good at R), and scp/push dumped file to RDS and github separately."}}},"pageContext":{"slug":"/notes/Regularly-Backup-MongoDB-with-R-script"}},
    "staticQueryHashes": ["63159454"]}