{
    "componentChunkName": "component---src-templates-note-template-js",
    "path": "/notes/Integration-Docker-with-Nextflow",
    "result": {"data":{"markdownRemark":{"html":"<p>Now I have leanred nextflow and docker. The next task is to integrate them. My purpose is to write each docker for each process. So call \"componentization\", or \"modularization\". So that in the future, I can \"form\" or \"assembly\" nextflow pipeline quickly with these components. This is possibly a bad idea, as Bioinformatics softwares have ton's of parameters, it's may not work to have just a container to run everydata...</p>\n<p>I need to say that until now (March 2022), there is still limited resource online about integration between nextflow and docker, though this is a \"selling point\" for nextflow. For example, when I google \"nextflow docker example\" on google, there are only 8 pages example. Most examples are directly using <code class=\"language-text\">--with-docker</code> parameter to pull a dockerhub, then run everything in it, without showing how file system looks like in both hostmachine and container.</p>\n<h2>Create a Docker Image</h2>\n<p>Firstly, I create a docker image, which containes a file named \"helloworld.txt\" in a folder called \"imageResource\". This is a file created in docker, not in the host machine.</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token comment\"># Download base image ubuntu 20.04</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:20.04</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH <span class=\"token string\">\"$PATH:/app/software\"</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span>  apt-get update <span class=\"token operator\">\\</span>\n  &amp;&amp; apt-get install -y wget <span class=\"token operator\">\\</span>\n  &amp;&amp; rm -rf /var/lib/apt/lists/*</span>\n\n<span class=\"token comment\"># Install fastp in this docker</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> wget http://opengene.org/fastp/fastp -P software/ <span class=\"token operator\">\\</span>\n    &amp;&amp; chmod a+x  software/fastp <span class=\"token operator\">\\</span>\n    &amp;&amp; mkdir imageResource <span class=\"token operator\">\\</span>\n    &amp;&amp; echo <span class=\"token string\">\"Hello World\"</span> > imageResource/helloworld.txt</span></code></pre></div>\n<p>The purpose of \"helloworld.txt\" file here equals to a file pre-COPIED into docker image for software usage. For instance, a reference genome for mapping, a target-region.csv for mapping .etc. Then create the docker with below comamnd, name it as <code class=\"language-text\">nf_fastp</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> build <span class=\"token parameter variable\">-t</span> nf_fastp ./nf-docker/docker_fastp</code></pre></div>\n<p>We can test the docker image like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">tian@slms-ci-beck-02 $ <span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> nf_fastp\nroot@c98b2ac172b6:/app<span class=\"token comment\"># ls</span>\nimageResource  software\nroot@c98b2ac172b6:/app<span class=\"token comment\"># ls imageResource/</span>\nhelloworld.txt\nroot@c98b2ac172b6:/app<span class=\"token comment\"># </span></code></pre></div>\n<p>It is working, the WORKDIR is <code class=\"language-text\">/app</code>, software <code class=\"language-text\">fastp</code> is installed in folder <code class=\"language-text\">software</code>, resource needed for calculation (not exist in host machine) is placed in <code class=\"language-text\">imageResource</code>.</p>\n<h2>Create a Nextflow script</h2>\n<p>The script is super simple, it only do one thing, copy the helloworld.txt file to <code class=\"language-text\">/data</code> folder. And <code class=\"language-text\">/data</code> folder is the share folder between host machine and container. <strong>The docker image is imported directly in process.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">stringArray = Channel.from(\"A\", \"B\", \"C\" )\n\nprocess 'test_docker_image' {\n    container 'nf_fastp'\n    publishDir \"./result\", mode: 'copy'\n    \n    input:\n      val x from stringArray\n\n    output:\n      file \"*.txt\" into result_ch\n    script:\n\n    \"\"\"\n    cp /app/imageResource/helloworld.txt /app/data/sharedFolderCopyHelloWorld.txt\n    cp /app/imageResource/helloworld.txt outputCopyHelloWork.txt\n    echo ${x} > ${x}.txt\n    \"\"\"\n}</code></pre></div>\n<p>Since here I need to use docker, <code class=\"language-text\">nextflow.config</code> file need to be modified a bit. <strong>A simple way is to create a file named nextflow.config in the same folder. Then add below content:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker {\n    enabled = true\n    runOptions = \" -v /scratch1/Tian/Cansor/Nextflow/S03_MyNextFlow/syncFolder:/app/data\"\n}</code></pre></div>\n<p>The important here is runOption, the <code class=\"language-text\">-v</code> parameter means mounting volumn of host machine to consider, as a shared space. The <code class=\"language-text\">/app/data</code>  is the folder in container, that's where the first <code class=\"language-text\">cp</code> command target for. Then run the nextflow script as:</p>\n<h2>Run nextflow and check results</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">nextflow <span class=\"token parameter variable\">-log</span> ./log/debugLog run main.nf <span class=\"token parameter variable\">-resume</span></code></pre></div>\n<p>The output is like below. I exported the 4 results:</p>\n<ol>\n<li>\n<p><strong>sharedFolderCopyHelloWorld.txt (light-blue)</strong>. This is achived by copy the pre-created helloworld.txt file into sharedFolder. The sharedFolder is created in <code class=\"language-text\">nextflow.config</code>, which mount /scratch1/Tian/Cansor/Nextflow/S03_MyNextFlow/syncFolder folder in hostmachine on /app/data folder in container. In this case, docker can directly write/read file in shared folder, all export files can be put there, it has nothing to do with nextflow. <strong>Note that the syncFolder MUST pre-exist in current folder. Otherwise it will trigger error.</strong></p>\n</li>\n<li>\n<p><strong>outputCopyHelloWork.txt (yellow) in work folder</strong>. This is the working folder for nextflow. It looks like after integration between nextflow and docker, when container start it's automatically located in this \"work/31/XXX\" folder. So if any command in container produce any file in current folder, it falled into control of nextflow. <strong>Thus, I suspect nextflow will do another mount for the work directory into docker</strong>. In theory, this folder is not easy accessible for user, thus the main purpose to create file here, is to export into channel for downstream analysis.</p>\n</li>\n<li>\n<p><strong>outputCopyHelloWork.txt (red)</strong>. This file is copy-exported by nextflow. It is achived by firstly export the work-directory-created outputCopyHelloWork.txt file into nextflow channel. Then use publishDir to export it.</p>\n</li>\n<li>\n<p><strong>A/B/C.txt</strong>. These files are created by docker, by taking the input from channel,</p>\n</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 427px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64b083b266b6927c9cf3a1a37b5c57c5/a7c74/figure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 184%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAlCAYAAABCr8kFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD6UlEQVRIx6VVaXOjRhTUT4iFAAGSQCAOIcQhxCFOHbbX2biyrtSWK0lV/v/P6NQ8W1rbG2HL+dA1IFQ9b1736+mFgYddW+Dm0KCpclRFCseeQRwKkOXhxehNpyrSdXgiGvAcJEmkj8f1IkJG0pQZvYxHMpTTR/EnSNLx9w5CY6YjzdbY7RtEqwADUYAoDyFIr3Eke1o7CANzim9VgtqzYIscFoqAhfwarixg9NEKK0vDNgmQhwtoQx66LJ5gyCI0WcRS4WHJAsSPEG6sKcpNAt9fQBgKkBQJQ3lIkOQheHkIUxZgX0K4jgMs/QU4fgBe5AmD55UbikT44Qpbe4pDGuJ+W+C2TGhl+H1f4bZYI5qb8OUBHEUkcUiYLsLInOK3LMJDk+KhThGqMlyJh8fEUQTMpQEcsY+xOPjhyw5/9nTHRlwXKK+3aO+uke9qpG2FfN+gOLTYHFokbQk3DqmvR5+eM33P8FyU93dwNhlkz4Ua+tCiAGoUYOR7GAdLguS54BUJgjDonKTeVJugSFfI1gHKPEYWB0iiJdKVj12dY5NEqPI18iREy97zGKORdL5CXZ/CdR00dY7DrqKg+PXLDqvIx2w2hWnqsCyDVnPGMIWidBAahg7HsVCXGaVNU2WIIx+j5+OJIv8TOo9sGFMiLPI1qiJBXWVYenMM34mvjgoZoUnTwiKMIYkDKMon44sdee5Y2GQxVcngL91PkT2JYqiwHR27tiRBrvc1otB798jvEjJRrncV4pUPVR29qvCSask2gb8gQbyFTbM64PsnRVmlrJ8MLzc4BxJl4brI0wSGYWBmGLAtC3PHgWma0FQN/f4AHDcgG/H8oDO1e5OJgqo08cdDgr8eS/z5WOLx+wb//N3S++P3Aoe9jbpy4c5tBMs5hYMgcBDFp01eojeeKFjHLvbtGvdfG3y9q/Dtfou7mwJ1GWHbxLjZZ7jeb8j022ZDbeH5PpG+RW8202FbJuoyJ5RFRlDVCX65ugLHcbjq99Hvs+c+OO6qUyTqIfNhuVmTqdn4zR2TBGEhwOb2LbqE+TEpbOzKlOzDLv6XAdCl6hlCC3m2Ok1L4LufMvWzsTWqsK032DYFIQqX/2P0ZhNYjkaE+21JStqW8Wr0LpqUJ2M7JAhLHE0bn2L+iIviS2eECwdZusJkrJAY47GCyWRE61GctzgbsLquYbl06bisfyxx9tuKrgNmoTxdUXqzP7MN2SadFarqGGGwoAuITQGLLwZGeHto6JlZiX37ct3SxuOxfJ5wZpnYP+cgSx1m6P/q1dHQ74nU87w57c6OxoKCqfsRA5/toecvaexY75J1SOtx9D5zSf0LpB0FVchVIiYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Output of docker\"\n        title=\"Output of docker\"\n        src=\"/static/64b083b266b6927c9cf3a1a37b5c57c5/a7c74/figure.png\"\n        srcset=\"/static/64b083b266b6927c9cf3a1a37b5c57c5/63868/figure.png 250w,\n/static/64b083b266b6927c9cf3a1a37b5c57c5/a7c74/figure.png 427w\"\n        sizes=\"(max-width: 427px) 100vw, 427px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"date":"March 12, 2022","slug":"/notes/Integration-Docker-with-Nextflow","title":"Integration Docker with Nextflow","tags":["nextflow","docker"],"abstract":"After learning the minium knowledge about docker and nextflow, now I want to join them two. To me, the hardest part for both docker and nextflow are the file system, so it requires perfect match and file/folder between containers and hostmachine."}}},"pageContext":{"slug":"/notes/Integration-Docker-with-Nextflow"}},
    "staticQueryHashes": ["63159454"]}