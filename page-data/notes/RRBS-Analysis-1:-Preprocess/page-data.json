{"componentChunkName":"component---src-templates-note-template-js","path":"/notes/RRBS-Analysis-1:-Preprocess","result":{"data":{"markdownRemark":{"html":"<p>I am working on a RRBS (Reduced representation bisulfite sequencing) project, which is generated from Zebrafish Retina tissue. It's my first time to work on this type of data, so I wil record a bit my actions here.</p>\n<p>The RRBS file I recieved is in folder contains many folders, the structure is below. </p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token operator\">$</span> tree <span class=\"token operator\">-</span>d <span class=\"token number\">190822</span>_D00623_0193_AH3Y2YBCX3<span class=\"token operator\">/</span>\n<span class=\"token number\">190822</span>_D00623_0193_AH3Y2YBCX3<span class=\"token operator\">/</span>\n├── Data\n│   ├── Intensities\n│   │   ├── BaseCalls\n│   │   │   ├── L001\n│   │   │   │   ├── C100.<span class=\"token number\">1</span>\n│   │   │   │   ├── C10.<span class=\"token number\">1</span>\n│   │   │   │   ├── C101.<span class=\"token number\">1</span>\n│   │   │   │   ├── C102.<span class=\"token number\">1</span></code></pre></div>\n<p>If I navigate into the deepest folder, the file format is .bcl file. Binary Base Call (BCL) files are the raw data files generated by the Illumina sequencers. The FASTQ is a text-based sequence file format that is generated from the BCL file that stores both raw sequence data and quality scores.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token operator\">/</span><span class=\"token number\">190822</span>_D00623_0193_AH3Y2YBCX3<span class=\"token operator\">/</span>Data<span class=\"token operator\">/</span>Intensities<span class=\"token operator\">/</span>BaseCalls<span class=\"token operator\">/</span>L001<span class=\"token operator\">/</span>C100.<span class=\"token number\">1</span><span class=\"token operator\">$</span> ls <span class=\"token operator\">*</span>.bcl\ns_1_1101.bcl  s_1_1107.bcl  s_1_1113.bcl  s_1_1203.bcl  s_1_1209.bcl  s_1_1215.bcl  s_1_2105.bcl  s_1_2111.bcl  s_1_2201.bcl  s_1_2207.bcl  s_1_2213.bcl\ns_1_1102.bcl  s_1_1108.bcl  s_1_1114.bcl  s_1_1204.bcl  s_1_1210.bcl  s_1_1216.bcl  s_1_2106.bcl  s_1_2112.bcl  s_1_2202.bcl  s_1_2208.bcl  s_1_2214.bcl\ns_1_1103.bcl  s_1_1109.bcl  s_1_1115.bcl  s_1_1205.bcl  s_1_1211.bcl  s_1_2101.bcl  s_1_2107.bcl  s_1_2113.bcl  s_1_2203.bcl  s_1_2209.bcl  s_1_2215.bcl\ns_1_1104.bcl  s_1_1110.bcl  s_1_1116.bcl  s_1_1206.bcl  s_1_1212.bcl  s_1_2102.bcl  s_1_2108.bcl  s_1_2114.bcl  s_1_2204.bcl  s_1_2210.bcl  s_1_2216.bcl\ns_1_1105.bcl  s_1_1111.bcl  s_1_1201.bcl  s_1_1207.bcl  s_1_1213.bcl  s_1_2103.bcl  s_1_2109.bcl  s_1_2115.bcl  s_1_2205.bcl  s_1_2211.bcl\ns_1_1106.bcl  s_1_1112.bcl  s_1_1202.bcl  s_1_1208.bcl  s_1_1214.bcl  s_1_2104.bcl  s_1_2110.bcl  s_1_2116.bcl  s_1_2206.bcl  s_1_2212.bcl</code></pre></div>\n<h2>1. BCL file to fastq file</h2>\n<p>So firstly I need to try convert these files into fastq file. <code class=\"language-text\">bcl2fastq</code> is the tool will be used here. The code is here:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">bcl2fastq  <span class=\"token operator\">-</span><span class=\"token operator\">-</span>runfolder<span class=\"token operator\">-</span>dir bclfilefolder <span class=\"token operator\">-</span>p <span class=\"token number\">40</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>output<span class=\"token operator\">-</span>dir .<span class=\"token operator\">/</span>BCL2FASTQ <span class=\"token operator\">-</span><span class=\"token operator\">-</span>no<span class=\"token operator\">-</span>lane<span class=\"token operator\">-</span>splitting  <span class=\"token operator\">-</span><span class=\"token operator\">-</span>use<span class=\"token operator\">-</span>bases<span class=\"token operator\">-</span>mask Y<span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>I6Y<span class=\"token operator\">*</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>minimum<span class=\"token operator\">-</span>trimmed<span class=\"token operator\">-</span>read<span class=\"token operator\">-</span>length <span class=\"token number\">0</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>mask<span class=\"token operator\">-</span>  short<span class=\"token operator\">-</span>adapter<span class=\"token operator\">-</span>reads <span class=\"token number\">0</span> <span class=\"token operator\">&amp;</span><span class=\"token operator\">></span> .<span class=\"token operator\">/</span>BCL2FASTQ<span class=\"token operator\">/</span>bcl2fastq_log.txt</code></pre></div>\n<p>After transforming to fastq file, now we can start to follow the preprocess pipeline provided by NuGEN company. Compared with other RRBS data, NuGEN company provide a series of unique scripts and actions... like add some special adapter in their reads, which means, during the analysis, we should do some special action on their data, instead of following common pipeline. For example, they provided a <a href=\"https://github.com/nugentechnologies/NuMetRRBS\">Pipeline</a> I can follow</p>\n<h2>2. General Triming</h2>\n<p>The firstly we need to do is general triming, which removed adaptor added in sequencing step, the code we use is:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">trim_galore -a AGATCGGAAGAGC R1.FQ</code></pre></div>\n<p>Importantly, I find a perfect command to finish triming in parallel!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">parallel --plus &#39;trim_galore -a AGATCGGAAGAGC {...}.fastq.gz&#39; ::: *.fastq.gz</code></pre></div>\n<p>Above is the first step triming, which removes some general adaptor, as long as you did sequencing, you need to do below triming I believe.</p>\n<h2>3. NuGEND Diversity Triming</h2>\n<p>Then, their compnay provided a <a href=\"https://github.com/nugentechnologies/NuMetRRBS\">script on github</a> to trim adaptor they added on reads:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">parallel --plus &#39;python ../NuGENDiversityTrimming/trimRRBSdiversityAdaptCustomers.py -1 {...}.fastq.gz&#39; ::: *.fastq.gz</code></pre></div>\n<p>Then we would have a new file, named as <code class=\"language-text\">XXX_trimmed.fq_trimmed.fa.gz</code></p>\n<p>After TWO-STEP triming, you get below result:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">regmtyu<span class=\"token operator\">@</span>rds<span class=\"token operator\">-</span>gw<span class=\"token operator\">-</span><span class=\"token number\">007</span><span class=\"token operator\">:</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>rd00qp<span class=\"token operator\">/</span>Zebrafish2<span class=\"token operator\">/</span>SecondRun<span class=\"token operator\">/</span>NuGEN_DIVERSITY_TRIMING<span class=\"token operator\">$</span> ls\nBc<span class=\"token operator\">-</span><span class=\"token number\">01</span>_S1_R1_001_trimmed.fq_trimmed.fq.gz  Bc<span class=\"token operator\">-</span><span class=\"token number\">03</span>_S3_R1_001_trimmed.fq_trimmed.fq.gz  Bc<span class=\"token operator\">-</span><span class=\"token number\">05</span>_S5_R1_001_trimmed.fq_trimmed.fq.gz  nugen_diversity_trming.log\nBc<span class=\"token operator\">-</span><span class=\"token number\">02</span>_S2_R1_001_trimmed.fq_trimmed.fq.gz  Bc<span class=\"token operator\">-</span><span class=\"token number\">04</span>_S4_R1_001_trimmed.fq_trimmed.fq.gz  Bc<span class=\"token operator\">-</span><span class=\"token number\">06</span>_S6_R1_001_trimmed.fq_trimmed.fq.gz  Undetermined_S0_R1_001_trimmed.fq_trimmed.fq.gz</code></pre></div>\n<p>In above figure, the top panel is results from first triming, and the bottom panel are result from second triming.</p>\n<h2>4. Prepare Bismark Genome</h2>\n<p>Then I can start to do Alignment. According to Nugen's requirement, I will use Bismark. Firstly I created a folder called Bismark, to placing various files related to Alignment. The vital step is prepare genome for alignment, the genome was downloaded from <a href=\"ftp://ftp.ensembl.org/pub\">ensmbl website</a>. Since we are working on Zebrafish, the Genome version I am using is <strong>Danio_rerio.GRCz11</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">wget ftp://ftp.ensembl.org/pub/release-98/fasta/danio_rerio/dna/Danio_rerio.GRCz11.dna.primary_assembly.fa.gz</code></pre></div>\n<p>Then put <strong>this unziped file under folder called <code class=\"language-text\">Genome</code></strong>, Then use commands to prepare genome:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bismark_genome_preparation ./Genome</code></pre></div>\n<p>It would take about 0.5 hour. Then two sub folder would emerge from Genome folder: <code class=\"language-text\">CT_conversion</code> and <code class=\"language-text\">GA_conversion</code>. I don't what exactly that are they for yet...</p>\n<h2>5. Bismark Alignment</h2>\n<p>After building alignment genome, we can now run Alignment, I created a small R script below to run Bismark on these <code class=\"language-text\">trimmed.fq.gz</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Samples &lt;- dir(&#39;../BCL2FASTQ/NuGENDiversityTrimming&#39;)\nSamples &lt;- Samples[sapply(Samples,function(x) &quot;trimmed.fq.gz&quot; %in% strsplit(x,split=&#39;_&#39;)[[1]])]\n\nfor(i in Samples) {\n    message(&#39;\\\\n-----------------------------------------------&#39;)\n    message(&#39;Runing &#39;,i,&#39; with Bismark alignment now...&#39;)\n\n    cmd &lt;- paste(&#39;bismark --parallel 8 --output_dir ./Results --bowtie2 ./Genome ../BCL2FASTQ/NuGENDiversityTrimming/&#39;,i,sep=&#39;&#39;)\n    message(cmd)\n    system(cmd,ignore.stdout=TRUE)\n}</code></pre></div>\n<p>This step is actually quite fast. Note that <code class=\"language-text\">-parallel</code> parameter above is <strong>NOT</strong> simply cores/thread, but seems to be times of resources will be allocated to row Bowtie,  normally 8 is good enough. And we have another issue here, after Bismark, Nugen will use Sam files for Nudup, but I can't believe <strong>Bismark seems only support bam file for multi-core</strong>. So I can only output as bam file, like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">regmtyu<span class=\"token operator\">@</span>rds<span class=\"token operator\">-</span>gw<span class=\"token operator\">-</span><span class=\"token number\">007</span><span class=\"token operator\">:</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>rd00qp<span class=\"token operator\">/</span>Zebrafish2<span class=\"token operator\">/</span>SecondRun<span class=\"token operator\">/</span>BISMARK<span class=\"token operator\">$</span> ls\nBc<span class=\"token operator\">-</span><span class=\"token number\">01</span>_S1_R1_001_trimmed.fq_trimmed_bismark_bt2.bam            Bc<span class=\"token operator\">-</span><span class=\"token number\">05</span>_S5_R1_001_trimmed.fq_trimmed_bismark_bt2.bam\nBc<span class=\"token operator\">-</span><span class=\"token number\">01</span>_S1_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt  Bc<span class=\"token operator\">-</span><span class=\"token number\">05</span>_S5_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt\nBc<span class=\"token operator\">-</span><span class=\"token number\">02</span>_S2_R1_001_trimmed.fq_trimmed_bismark_bt2.bam            Bc<span class=\"token operator\">-</span><span class=\"token number\">06</span>_S6_R1_001_trimmed.fq_trimmed_bismark_bt2.bam\nBc<span class=\"token operator\">-</span><span class=\"token number\">02</span>_S2_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt  Bc<span class=\"token operator\">-</span><span class=\"token number\">06</span>_S6_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt\nBc<span class=\"token operator\">-</span><span class=\"token number\">03</span>_S3_R1_001_trimmed.fq_trimmed_bismark_bt2.bam            log\nBc<span class=\"token operator\">-</span><span class=\"token number\">03</span>_S3_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt  Undetermined_S0_R1_001_trimmed.fq_trimmed_bismark_bt2.bam\nBc<span class=\"token operator\">-</span><span class=\"token number\">04</span>_S4_R1_001_trimmed.fq_trimmed_bismark_bt2.bam            Undetermined_S0_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt\nBc<span class=\"token operator\">-</span><span class=\"token number\">04</span>_S4_R1_001_trimmed.fq_trimmed_bismark_bt2_SE_report.txt</code></pre></div>\n<h2>6. Samtools Transfer</h2>\n<p>Then I use Samtools to transfer all bam files into sam file. Again I used parallel here:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">parallel --plus &#39;samtools view -h -o {...}.sam {...}.fq_trimmed_bismark_bt2.bam&#39; ::: *.bam</code></pre></div>\n<h2>7. Strip Bismark Result</h2>\n<p>Again here it comes to Nugen-specific time. We useNudup here, but before that we need a small script. (Is that common for big companies use small scripts for jobs?)</p>\n<p>After downloading, I use linux command to make it work:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">chmod +x ./strip_bismark_sam.sh</code></pre></div>\n<p>Then again, I use parallel command to run it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">parallel --plus &#39;./strip_bismark_sam.sh {...}.sam&#39; ::: *.sam</code></pre></div>\n<p>To be honest I still don't know what is this step for...</p>\n<h2>8. Run Nudup</h2>\n<p>Finally I reach the final step, to run Nudup, I wrote a small loop script to run it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Samples &lt;- dir(&#39;../Index&#39;)\nSamples &lt;- sapply(Samples,function(x) paste(strsplit(x,split=&quot;_&quot;)[[1]][1:2],collapse=&quot;_&quot;))\n\nfor(i in Samples) {\n    message(&#39;\\\\n-----------------------------------------------&#39;)\n    message(&#39;Runing &#39;,i,&#39; with Nudup now...&#39;)\n\n    cmd &lt;- paste(&#39;python ./nudup.py -f ../Index/&#39;,i,&#39;_I1_001.fastq.gz -o &#39;,i,&#39; ../Results/&#39;,i,&#39;_R1_001_trimmed.sam_stripped.sam&#39;,sep=&#39;&#39;)\n    message(cmd)\n    system(cmd,ignore.stdout=TRUE)\n}</code></pre></div>\n<p>It's really slow and no parallel... After a long time, I final get fully processed bam file.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">NUDUP<span class=\"token operator\">$</span> ls\nBc<span class=\"token operator\">-</span><span class=\"token number\">01</span>_S1_dup_log.txt         Bc<span class=\"token operator\">-</span><span class=\"token number\">02</span>_S2.sorted.markdup.bam  Bc<span class=\"token operator\">-</span><span class=\"token number\">04</span>_S4_dup_log.txt         Bc<span class=\"token operator\">-</span><span class=\"token number\">05</span>_S5.sorted.markdup.bam  Ready  TMP3  TMP6\nBc<span class=\"token operator\">-</span><span class=\"token number\">01</span>_S1.sorted.markdup.bam  Bc<span class=\"token operator\">-</span><span class=\"token number\">03</span>_S3_dup_log.txt         Bc<span class=\"token operator\">-</span><span class=\"token number\">04</span>_S4.sorted.markdup.bam  Bc<span class=\"token operator\">-</span><span class=\"token number\">06</span>_S6_dup_log.txt         TMP    TMP4\nBc<span class=\"token operator\">-</span><span class=\"token number\">02</span>_S2_dup_log.txt         Bc<span class=\"token operator\">-</span><span class=\"token number\">03</span>_S3.sorted.markdup.bam  Bc<span class=\"token operator\">-</span><span class=\"token number\">05</span>_S5_dup_log.txt         Bc<span class=\"token operator\">-</span><span class=\"token number\">06</span>_S6.sorted.markdup.bam  TMP2   TMP5</code></pre></div>\n<p>The 6 bam file in above folder is what I will use into future Downstream Analysis.</p>","frontmatter":{"date":"September 13, 2020","slug":"/notes/RRBS-Analysis-1:-Preprocess","title":"RRBS Analysis 1: Preprocess","abstract":"Recently, I got a quick task to analysis RRBS data. Since I had no experience on that kind of data format. Here I record a bit my analysis steps. This is the first post related to this data analysis work, it merely focused on preprocess work from bcl file to final BAM file. Note that this data is generated by NuGEN company, thus some unique scripts is used here."}}},"pageContext":{"slug":"/notes/RRBS-Analysis-1:-Preprocess"}}}