{"componentChunkName":"component---src-templates-note-template-js","path":"/notes/MeDIP-seq-Analysis-1:-Preprocessing","result":{"data":{"markdownRemark":{"html":"<p>I am not analysing a set of hMeDIP-seq data, it's my first time working on this type of data, so I want to record a bit code and steps I followed here. Also, I want to organize code into a proper pipeline here, automate most works, like seal them into couple R functions, so that I can use them in the future easily. Like what I have done for RRBS and Array data.</p>\n<h2>1. Data Preparation</h2>\n<p>The works is actually started from a set of splitted fq file. I don't know why they are initially in this status, but it's not good. So I merged those fastq file into each sample with my own script.</p>\n<p>Script for Merging fq files based on Sample Name</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">```r\n# A script I wrote to merge fq files based on pheno-sample-fraction.\n# Author: Yuan Tian\n\ndirectory &lt;- &quot;../20110401_LewisS_AM_HydrxMeth/&quot;\n\nresultsDir &lt;- &quot;./Merged&quot;\nif (!file.exists(resultsDir)) dir.create(resultsDir)\n\nindex &lt;- read.csv(&quot;../20110401_LewisS_AM_HydrxMeth/index.csv&quot;, as.is=TRUE, header=F)\ncolnames(index) &lt;- c(&quot;file&quot;, &quot;B&quot;, &quot;Sample&quot;, &quot;Index&quot;)\n\nSamples &lt;- names(table(index$Sample))\nSamples &lt;- Samples[Samples != &quot;&quot;]\n\nfor(x in Samples)\n{\n    message(x)\n    tmp &lt;- paste(paste(directory, index$file[index$Sample == x], sep=&quot;&quot;), collapse=&quot; &quot;)\n    tmp &lt;- paste(&quot;cat &quot;, tmp, &quot; &gt; ./Merged/&quot;, x, &quot;.fq.gz&quot;, sep=&quot;&quot;)\n    system(tmp)\n}\n```</code></pre></div>\n<p>After above code, files are presented into a better format, like below. There are two types of data, <strong>bnds</strong> indicates they are samples with antibody, which means they should have real signals on it. The <code class=\"language-text\">Inp</code> samples are background control samples, they will be used by calling peaks for bnds samples against them.</p>\n<p>In my data, there are totally 4 phenotypes, NC(Normal Colon), NL(Normal Liver), TC(Tumour Colon) and LT (Liver Tumour). However, there are only two phenotypes (NC and LT) have Inp samples, so I think later in Peak Calling the only way I can do is to merge Inps togather, into a big <code class=\"language-text\">MergedInp.bam</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span> regmtyu<span class=\"token operator\">@</span>SLMSICANBECK01<span class=\"token operator\">:</span><span class=\"token operator\">/</span>Data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>Postdoc<span class=\"token operator\">/</span>BathCRC<span class=\"token operator\">/</span>MeDIP<span class=\"token operator\">-</span>seq<span class=\"token operator\">/</span><span class=\"token number\">0.</span>Data<span class=\"token operator\">/</span>Merged<span class=\"token operator\">$</span> ls\nSUL_CRC2_24NA_hmC_bnd.fq.gz    SUL_CRC2_37NC_hmC_bnd.fq.gz  SUL_LT51_Inp.fq.gz  SUL_LT55_bnd.fq.gz  SUL_NC51_Inp.fq.gz  SUL_NC55_Inp.fq.gz  SUL_NL55_bnd.fq.gz\nSUL_CRC2_24NC_hmC_bnd.fq.gz    SUL_CRC2_42NC_hmC_bnd.fq.gz  SUL_LT52_bnd.fq.gz  SUL_LT55_Inp.fq.gz  SUL_NC52_bnd.fq.gz  SUL_NL49_bnd.fq.gz  SUL_TC49_bnd.fq.gz\nSUL_CRC2_24NC_hmC_Input.fq.gz  SUL_CRC2_44NC_hmC_bnd.fq.gz  SUL_LT52_Inp.fq.gz  SUL_NC49_bnd.fq.gz  SUL_NC52_Inp.fq.gz  SUL_NL51_bnd.fq.gz  SUL_TC51_bnd.fq.gz\nSUL_CRC2_35NC_hmC_bnd.fq.gz    SUL_LT49_bnd.fq.gz           SUL_LT53_bnd.fq.gz  SUL_NC49_Inp.fq.gz  SUL_NC53_bnd.fq.gz  SUL_NL52_bnd.fq.gz  SUL_TC52_bnd.fq.gz\nSUL_CRC2_35NC_hmC_Input.fq.gz  SUL_LT51_bnd.fq.gz           SUL_LT53_Inp.fq.gz  SUL_NC51_bnd.fq.gz  SUL_NC53_Inp.fq.gz  SUL_NL53_bnd.fq.gz  SUL_TC53_bnd.fq.gz</code></pre></div>\n<p>The initial samples are <strong>not</strong> going to be used here: SUL_CRC2... I guess they are Methylation MeDIP-seq data.</p>\n<h2>2. FastQC Report</h2>\n<p>This part is merely for generate QC report for fastq file, fastqc command is very easy to use, and merely there are many parameters after that, and they are mostly working well. Below is my code code for fastQC, written in R. Actually there is no need to use R to write it, I do it because I am not good at shell, so I prefer a R script to do everything later.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">```r\ncmd &lt;- paste0(&quot;fastqc --threads &quot; , threads, &quot;  --outdir ./myFastQC &quot; , directory ,&quot;* &amp;&gt; ./myLog/myFastQC.log&quot;)\nsystem(cmd)\n```</code></pre></div>\n<p>Note that I created a folder to allow fastQC files to put into it.</p>\n<h2>3. Fastp Triming</h2>\n<p>Fastp is so easy to use in terms of triming, as it's very fast and automatically detect all adapters. Note that we need above fastQC work to make sure if this data is preh64 (a very old data format), or it's preh33. It would be labelled in the html report of fastQC as <code class=\"language-text\">encode</code>.</p>\n<p>core code for fastp</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">```r\ncmd &lt;- paste0(&quot;parallel --plus &#39;fastp -h ./myFastp/{/..}.html -j ./myFastp/{/..}.json -i {} -o ./myFastp/{/..}.fastp.fq&#39; ::: &quot;, directory, &quot;* &amp;&gt; ./myLog/myFastp.log&quot;)\n```</code></pre></div>\n<p>It would take very short time if I use above parallel running.</p>\n<h2>4. Bowtie2 Alignment</h2>\n<p>There are so many tools now out there but still seems bowtie2 is the main option for medip-seq. So the firstly think I need to do is download index for bowtie2, directly from <a href=\"http://bowtie-bio.sourceforge.net/bowtie2/index.shtml\">official website</a>. I used <code class=\"language-text\">GRCh38 no-alt</code>. Then I wrote a loop in R to run samples one by one.</p>\n<p>There the threads parameter is 30. core code for bowtie2 alignment:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">message<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n[ Section 3: bowtie2 alignment ] (require bowtie2 installed on server)\"</span><span class=\"token punctuation\">)</span>\nmessage<span class=\"token punctuation\">(</span><span class=\"token string\">\"!!! Prepare genome from bowtie2 into a folder called Genome in this folder yourself, unzip it.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myAlignment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myAlignment\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> dir<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myFastp/\"</span><span class=\"token punctuation\">,</span> pattern<span class=\"token operator\">=</span><span class=\"token string\">\"*.fastp.fq\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    name <span class=\"token operator\">&lt;-</span> strsplit<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> split<span class=\"token operator\">=</span><span class=\"token string\">\"[.]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    cmd <span class=\"token operator\">&lt;-</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"bowtie2 -p \"</span><span class=\"token punctuation\">,</span>threads<span class=\"token punctuation\">,</span><span class=\"token string\">\" -q --local -x ./Genome/GRCh38_noalt_as/GRCh38_noalt_as -U  ./myFastp/\"</span><span class=\"token punctuation\">,</span> i <span class=\"token punctuation\">,</span> <span class=\"token string\">\" | samtools view -bS - > ./myAlignment/\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span><span class=\"token string\">\".bam\"</span><span class=\"token punctuation\">)</span>\n     message<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n     system<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>5. Blacklist Removing</h2>\n<p>This is an important step, I missed this one previously, that I can't get any resonable results at all.</p>\n<p>This is a step I ignored before, that I should removed Blacklist Region after mapping. Blacklisted regions are genomic regions with anomalous, unstructured, high signal or read counts in NGS experiments, independent of cell type or experiment. These regions tend to have a very high ratio of multi-mapping to unique mapping reads and a high variance of mappability and simple</p>\n<p>mappability filters do not account for them. These regions are often found at repetitive regions (Centromeres, Telomeres, Satellite repeats) and are troublesome for high throughput sequencing aligners and when computing genome wide correlations. These regions also confuse peak callers and result in spurious signal.</p>\n<p>There are two ways to find these Blacklist, one is to get pre-defined regions, another way is to get from <code class=\"language-text\">GreyListChIP</code> R pacakge. After my multiple trying, only the GreyListChIP way works. In general, the logic of GreyListChip is to generate null distribution, then find those region <strong>significantly high enriched</strong>, like p value 0.01, then it's likely to be a blacklist region.</p>\n<p>I calcualte grey list for all Inp samples, then merged them into one. Then removed blacklist from them:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myGreyList\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myGreyList\"</span><span class=\"token punctuation\">)</span>\n\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreyListChIP\"</span><span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">\"BSgenome.Hsapiens.UCSC.hg38\"</span><span class=\"token punctuation\">)</span>\n\n files <span class=\"token operator\">&lt;-</span> dir<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myAlignment\"</span><span class=\"token punctuation\">)</span>\n    files <span class=\"token operator\">&lt;-</span> unique<span class=\"token punctuation\">(</span>sapply<span class=\"token punctuation\">(</span>files<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> strsplit<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> split<span class=\"token operator\">=</span><span class=\"token string\">\"[.]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    Inps <span class=\"token operator\">&lt;-</span> files<span class=\"token punctuation\">[</span>grep<span class=\"token punctuation\">(</span><span class=\"token string\">\"Inp\"</span><span class=\"token punctuation\">,</span>files<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> Inps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        message<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n        gl <span class=\"token operator\">&lt;-</span> greyListBS<span class=\"token punctuation\">(</span>BSgenome.Hsapiens.UCSC.hg38<span class=\"token punctuation\">,</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myAlignment/\"</span><span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">,</span><span class=\"token string\">\".bam\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        export<span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">,</span>con<span class=\"token operator\">=</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"./myGreyList/\"</span><span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">,</span><span class=\"token string\">\"GreyList.bed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    cmd <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"cat ./myGreyList/* > ./MergedGreyList.bed\"</span>\n    system<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span></code></pre></div>\n<p>After generation of GreyList, we can use this list to do filtering on our bam file, with bedtool command:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">parallel <span class=\"token operator\">-</span><span class=\"token operator\">-</span>plus <span class=\"token string\">'bedtools intersect -v -abam {} -b ./MergedGreyList.bed > ./myGreyList/{/.}.grey_filtered.bam'</span> <span class=\"token operator\">::</span><span class=\"token operator\">:</span> .<span class=\"token operator\">/</span>myAlignment<span class=\"token operator\">/</span><span class=\"token operator\">*</span>.bam</code></pre></div>\n<h2>6.bigwig IGV visualisation</h2>\n<p>After removing, I used IGV to check the bam file across human genome.  Below are part of the samples. On the top is a grey Inpu sample, they are generally fine, but they have some gaps across whole genome.</p>\n<p>Purple colour are LT samples, the pink colours are two samples labelled as LT, but their plot looks very similar to NL.</p>\n<p>In later plot, we can see that LT49 and LT51 indeed looks weird. Maybe they made some mistake when they take sample from patient.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c8c1cb967b2595ca5ff6c73ce45c68de/7e11a/figure1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAADIklEQVQ4y01TaXPTVhTVD26/Qgsd2pkMEGBgSqClDJkQEmhIyNosDSZAEnZMvGuxNmuXY0mWLRknxB5Or54p8OHMefe8K9333j2Xa7fb6Pf7aLVa6HYT9Ho9pGn6BT0kSfo1TpKE5WTc6XQY4riDKIpI78KyHXCmaaLZbMIwTNSlOnheQK3GgycI368FAaIoEo8gywoURYUkSuw7ldaKqoHzfR9hGMH3PZi2Dq0hMyiaBFWrQ6e1qtcZLKeBhqlANxRougy/acPxDNiugVbg45BuyYlUQdc1qtCAWHJQzZuofbDAF0wIJYPYYppQtCAWHdTyNoSCjXrFhlJrQjjwSPegCA5s2wd3f/Y+Zh/cw8byHvZmPmNzYoh/bw7x5M4AL+dPsEO8/ecQT6cG2J0ZsL3c7SFbv5gbYOvGEI9vDVF9NoDT6ILb3d3D6zcv8OZZGZuXIjz6OcDyuQhrYxFyEzGWf40oDli8eTnC0i8hVn6LsPNHjO1rEeZPBVg6F2J3MoGUb4NzXRetMICjGjDpp8aTImPzeQXue3q3/Soa2wcwdopM0zfzMJ+W4L6VGCuLr6BtvId/oKDlNEdNSdMuZMnF4qyI+WmBYXWujtw/GtYXZDy8K+DhlICVv+uYulHBwj0RuXUdc6RdP3+AyYky9nMmdPUQnGXZ5MEmWcLCypqF5VUbq+s21gi5HQ9b2y4eLVlYWrGwseVgYdFkOdlelnN3RseDOQN7+4fkiBCc5/lk5i4q1LVL41WMj9dw5XIN167yuP1XnVjA2FgFF85Xcf13EWfPFHHxQhWTkzLl8fjxhzx+Ol3A9LSKUpm6nLn++PgIQRCTubswzQSWlZAFEvJmD46TMr1BHcx0Ve1QnMB1R7okxWTwDjyvR17sgMtGqt8/otHp0I9TnJz08OnTCEdHKWk9pv2vDwYfGWd6xt/yP9KhyNhxHFNwTO/YppE6pGohVQ2oekRVY2haSIjI/BGdLkSplL13QDdo01i28O6dh0LBp/w2GgZ12TAMupZNs6miWpUJCgPP05xKKrFCHyqMM5TLMotFUf2aO4o1ekMe/wGGwdJDX2pXbwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bigwig file\"\n        title=\"bigwig file\"\n        src=\"/static/c8c1cb967b2595ca5ff6c73ce45c68de/5a190/figure1.png\"\n        srcset=\"/static/c8c1cb967b2595ca5ff6c73ce45c68de/772e8/figure1.png 200w,\n/static/c8c1cb967b2595ca5ff6c73ce45c68de/e17e5/figure1.png 400w,\n/static/c8c1cb967b2595ca5ff6c73ce45c68de/5a190/figure1.png 800w,\n/static/c8c1cb967b2595ca5ff6c73ce45c68de/c1b63/figure1.png 1200w,\n/static/c8c1cb967b2595ca5ff6c73ce45c68de/7e11a/figure1.png 1235w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Until here, I think most basic preprocess are done. In theory, we should also remove duplicated reads, however our next step is MACS2 calling, the software will automatically remove those duplicated reads, so we don't need to do it.</p>","frontmatter":{"date":"November 09, 2020","slug":"/notes/MeDIP-seq-Analysis-1:-Preprocessing","title":"MeDIP-seq Analysis 1: Preprocessing","abstract":"Recently I am working on a Medip-seq data, which contains 4 phenotypes, and it's my first time working on this type of data. So I decided to record a bit this pipeline."}}},"pageContext":{"slug":"/notes/MeDIP-seq-Analysis-1:-Preprocessing"}}}