{
    "componentChunkName": "component---src-templates-note-template-js",
    "path": "/notes/Calculate-VCF-similarity-with-somalier",
    "result": {"data":{"markdownRemark":{"html":"<p>Following the <a href=\"https://yuantian1991.github.io/notes/Liftover-VCF-from-hg37-to-hg38-with-Picard\">last blog</a>, now what I want to do is to compare similarities between a seires of VCF files. So what I need to to is to compare newly-generated VCF files (<a href=\"https://yuantian1991.github.io/notes/Nextflow:-nf-core-sarek\">from nf-core Sarek</a>), with old generated VCF files. Here I am analysing <a href=\"https://www.personalgenomes.org.uk/\">PGP-UK project</a> data. All old VCF files can be download <strong>based (not through)</strong> on <a href=\"https://www.personalgenomes.org.uk/api/v1.3/all_variant\">this API</a>.</p>\n<p>Totally, I successfully downloaded 100 sample's old VCF files. Then I need to run the <a href=\"https://github.com/brentp/somalier\">somalier</a> program.</p>\n<h2>1. How somalier work?</h2>\n<p>I just quickly scanned the paper, the somalier works by:</p>\n<ol>\n<li>Compare a set of well-selected polymorphic loci. For each sample's VCF or BAM file.</li>\n<li>(A &#x26; B below) For each loci in the selected list. It will define if a loci is <code class=\"language-text\">HET (heterozygous)</code>, <code class=\"language-text\">HOMALT (homozygous alternate)</code>, <code class=\"language-text\">HOMREF (homozygous reference)</code>. Thus, for each sample, it will be converted to a <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mrow><mi>s</mi><mi>n</mi><mi>p</mi></mrow></msub><mo>∗</mo><mn>3</mn></mrow><annotation encoding=\"application/x-tex\">n_{snp} * 3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751388em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span></span></span></span></span> matrix.</li>\n<li>(C below) Then, for each two sample, compare their 3-column matrix row by row, count <code class=\"language-text\">IBS0 (identity-by-state zero)</code> or <code class=\"language-text\">IBS2 (identity-by-state two-sample share same status)</code>. IBS0 is number of rows that does not have any difference. Thus, smaller IBS0 means higher similarity. While IBS2 count rows do have difference, thus higher IBS2 means higher similarity.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 685px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6c390051447628d9cc3c218ac369bde5/8ce22/somalier_principle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAPoAAAD6AG1e1JrAAACjElEQVQ4y32TbY+cIBSF/f//aj9u9jWdpJ24jq7ujKAC8nJBBITWoZ1t2rT3gzHIwzn3eigYY9779I+KMaaUEELGmL+/FtM0VVU1DEPTNEqplNLlcqmuZa3NmwAAIdS27fv7e1VV5/O5aRrOeTEMw93d3fF4fHl5Wdc1pSSE6Pv+4+PjBhtjDofD8/NzWZan06lpmoeHB0JIEUJACAHANE15K2MMAG6e87Pve0KI1lpKaa3tui7GWGzbprX23mcgpUQpFUJ473+HhRAAYIwBAOfcPM877L231nrvhRAhBGstY+ytfMMY3zzHGPOJAMA5DyHM87xt264shFjX1XvPOSeECCHatsUYb9uW52etBQCtNQBkU9M07cohBM65cy5PK6U087nrOoxxCOEP27ln7z0h5NO2c25ZlgxP01TXdVVVCKGUUtbPjqSUlFLnHMb4p/L2qzK8bVsIwTkXQsiyKSXvvb8a2TfEmN+LcRxvmv8JWQrBgf725fD1cJCMpeu5RUqpruv7+/vX11etdQaWZXl6enp8fCzLMvNOCHPpp/KNNo26XJZhjFss6rp+u1bf92VZcs6VUsfj8XQ6tW3bdV1VVXsXSpphsJQs07SMoxnHXZkxRilljBljciRjjOfzGQAYY1LKvu9vY2OMjeO4e9m2HVZKCSEopcYYOfMcLCWE1jovEkJunRsAfb08P2+VlFIIsed2h2fvrjDne9oJMcbkzGd40YYRghBCPcIYF1abVetxHI0xCON1XWOMwzgCwDhNzlrF+SdszEypuP5tIUQBAEpKxtiyLIQQ51yMcb9YWu+LxlBKbzAoJaX8tD3PM2NsGAYA6Ps+KyOEpJQYY6VUzlmGOee3Ln4M7DvKfzr/tBlY/QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"somalier principle\"\n        title=\"somalier principle\"\n        src=\"/static/6c390051447628d9cc3c218ac369bde5/8ce22/somalier_principle.png\"\n        srcset=\"/static/6c390051447628d9cc3c218ac369bde5/63868/somalier_principle.png 250w,\n/static/6c390051447628d9cc3c218ac369bde5/0b533/somalier_principle.png 500w,\n/static/6c390051447628d9cc3c218ac369bde5/8ce22/somalier_principle.png 685w\"\n        sizes=\"(max-width: 685px) 100vw, 685px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol start=\"4\">\n<li>Finally, based on above metrics, other measurements like relatedness can be calculated:</li>\n</ol>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>𝚜</mi><mi>𝚑</mi><mi>𝚊</mi><mi>𝚛</mi><mi>𝚎</mi><mi>𝚍</mi><mo>−</mo><mi>𝚑</mi><mi>𝚎</mi><mi>𝚝</mi><mi>𝚜</mi><mo stretchy=\"false\">(</mo><mi>𝚒</mi><mo separator=\"true\">,</mo><mi>𝚓</mi><mo stretchy=\"false\">)</mo><mo>−</mo><mi>𝟸</mi><mo>∗</mo><mi>𝚒</mi><mi>𝚋</mi><mi>𝚜</mi><mi>𝟶</mi><mo stretchy=\"false\">(</mo><mi>𝚒</mi><mo separator=\"true\">,</mo><mi>𝚓</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">/</mi><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy=\"false\">(</mo><mi>𝚑</mi><mi>𝚎</mi><mi>𝚝</mi><mi>𝚜</mi><mo stretchy=\"false\">(</mo><mi>𝚒</mi><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mi>𝚑</mi><mi>𝚎</mi><mi>𝚝</mi><mi>𝚜</mi><mo stretchy=\"false\">(</mo><mi>𝚓</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(𝚜𝚑𝚊𝚛𝚎𝚍-𝚑𝚎𝚝𝚜(𝚒,𝚓)-𝟸∗𝚒𝚋𝚜𝟶(𝚒,𝚓)) / min(𝚑𝚎𝚝𝚜(𝚒),𝚑𝚎𝚝𝚜(𝚓))</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathtt\">shared</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathtt\">hets</span><span class=\"mopen\">(</span><span class=\"mord mathtt\">i</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathtt\">j</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.61111em;vertical-align:0em;\"></span><span class=\"mord mathtt\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathtt\">ibs0</span><span class=\"mopen\">(</span><span class=\"mord mathtt\">i</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathtt\">j</span><span class=\"mclose\">))</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">min</span><span class=\"mopen\">(</span><span class=\"mord mathtt\">hets</span><span class=\"mopen\">(</span><span class=\"mord mathtt\">i</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathtt\">hets</span><span class=\"mopen\">(</span><span class=\"mord mathtt\">j</span><span class=\"mclose\">))</span></span></span></span></span></div>\n<p>My math is bad, but I roughtly can understand the meaning is to calculate the fraction of number of shared HET among all HET, based on the sample with less HET on its metric data frame. <code class=\"language-text\">ibs0</code> is treated as something like penalty here. That's the principle of somilarity.</p>\n<blockquote>\n<p>somilarity is pretty fast to run, merely because it applied <strong>bitwise operations</strong> for 1-0 comparison. Cool, remind me old undergraduate age that we competing for faster ACM solutions...I should indeed try to impelement more bitwise operation in future coding.</p>\n</blockquote>\n<h2>2. Run somalier.</h2>\n<p>Firstly it does not need to be installed, at least not on Linux system. Just download from <a href=\"https://github.com/brentp/somalier/releases\">the release page from Github</a>.</p>\n<p>Below is the command to generated 3-column matrix for each sample from VCF.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">somalier extract -d extracted/ --sites sites.hg38.vcf.gz -f ./Homo_sapiens_assembly38.fasta your_vcf_file.vcf.gz</code></pre></div>\n<p>Below that for these parameters:</p>\n<ul>\n<li><code class=\"language-text\">--sites</code> requires the somalier curated SNP list, which can be downloaded from above link as well.</li>\n<li><code class=\"language-text\">-f</code> reference must be unzipped. And <strong>it's vital to find the correct version of reference, the way I do it is by checking VCF file meta data</strong>.</li>\n<li>For VCF files, it's fine there are multiple samples' variant information in one VCF file, or you can do it separately one by one.</li>\n</ul>\n<p>In my case, I have totally 3 batches of VCF files, generetaed from different reference, thus I have to separately run them with corresponding reference.</p>\n<p>After the run, for each sample, a binary object will be created in corresponding folder (<code class=\"language-text\">\\extracted</code>). Then below code will calculate the metrics like IBS0, IBS2, Relatedenss .etc.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">somalier relate extracted/*.somalier</code></pre></div>\n<p>The generated <code class=\"language-text\">somalier.html</code> file is really good for scatter plot visualisation. As it shows below, on the top right conor, it successfully identified VCFs generated from different time or batch, but from same sample. These samples have nearly 1 Relatedness and high IBS2.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2db6f27d2c1d8dec70bda126850d727b/eb3fa/myResult.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2ElEQVQ4y5VUy27bMBDkZ/dfeuihh57bDwhSFEUPNdJcGiSNBRdOLMuCE0UhJZLLxxSkJZmS7BYlsOCSSw6Hs0uy218ZstVvPG5ybIsdNnmO+pWDjIUmE01pQl6UuF9tkK232Oye0WgPLi14ayHkwerGgDVSxQ3T5pyDcz721lq0UoE3GkISqlqgkYRWWwhyEOTBtUXxxMHibu/hve9AHIx1cdzbtHnnEGdVi/zHNfLFd/jlTxjBwdKNUwsMD+ediIeAIeiygN2XwFMJTwQWGRkz2zCw+cuBKXffGUsBUv+l0bh5fDkLPMy5gzy9bBEwZRjOCRpe3hRYZPt/s5wYO3Xd8ZVxNn5qzKqqglJqUCJl+r/sIqCUB7CHfYO60QOzoOG7z8vR6bE+z2R/YOiisBarkqPVZgD8elfi7cV99G0nvEukcFMJ0qT0iQitrCXIOnxcrFG3NGOV7TiWxesMtJeLBT8kxhqDVml8u9uhEhLbZwE4CyIT4/3zfPPhCp8W6+hrohgL5rpbsP7JxcK3DlzSqPbSPrB//yWbVUC6/uxL6U9MtdtWLR72ovs85usSDY8/TPhZpn7otT5WABGN/FGWbffDHM2PxmGRUjoChpi1rkvSfH3A+gM9VDZU5guY5gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"somalier figure\"\n        title=\"somalier figure\"\n        src=\"/static/2db6f27d2c1d8dec70bda126850d727b/00d43/myResult.png\"\n        srcset=\"/static/2db6f27d2c1d8dec70bda126850d727b/63868/myResult.png 250w,\n/static/2db6f27d2c1d8dec70bda126850d727b/0b533/myResult.png 500w,\n/static/2db6f27d2c1d8dec70bda126850d727b/00d43/myResult.png 1000w,\n/static/2db6f27d2c1d8dec70bda126850d727b/eb3fa/myResult.png 1026w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>However, I noticed it will use the sample name listed in VCF file. Well...it make sense, but I need to change it a bit. Thus, finally, I need to draw the figure myself. I can get detailed output from <code class=\"language-text\">somalier.pairs.tsv</code> file. Modify the name, add some column for colour, then draw with ggplot2.</p>\n<h2>3. PED file support</h2>\n<p>This part I have not figure out yet since I don't need to do it in my work. It seems the user can support a PED file indicates sample's relationship, like parent, identical .etc. Like a list of phenotype to \"colour\" the scatter plot.</p>","frontmatter":{"date":"August 15, 2022","slug":"/notes/Calculate-VCF-similarity-with-somalier","title":"Calculate VCF similarity with somalier","tags":["VCF"],"abstract":"My task is a calculate similarity between VCF files, somalier successfully done this task. Here are some code I may use in the future."}}},"pageContext":{"slug":"/notes/Calculate-VCF-similarity-with-somalier"}},
    "staticQueryHashes": ["63159454"]}