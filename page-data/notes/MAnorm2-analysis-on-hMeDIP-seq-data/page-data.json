{"componentChunkName":"component---src-templates-note-template-js","path":"/notes/MAnorm2-analysis-on-hMeDIP-seq-data","result":{"data":{"markdownRemark":{"html":"<p>The third method I am trying here now is <a href=\"https://github.com/tushiqi/MAnorm2\">MAnorm2</a>, developed by my PhD classmate Shiqi Tu. According to the introduction, this package merely focus on normalisastion and differential calling, which is what I want. Note that MAnorm2 take MACS<em>1.4.2-generated bed file as input, thus I assume it only take sig-peaks from MACS</em>1.4.2 as peaks.</p>\n<h2>1. Software Installation</h2>\n<p>Firstly I need to install the software, which is actually a two-step work, install MAnorm2 R package, and <a href=\"https://github.com/tushiqi/MAnorm2_utils\">MAnorm2_utils</a> python software for data preparation. The way to install MAnorm2 is:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/tushiqi/MAnorm2.git\n<span class=\"token builtin class-name\">cd</span> MAnorm2/dist\nR CMD INSTALL MAnorm2_1.1.0.tar.gz</code></pre></div>\n<p>And the way to install MAnorm2_utils is:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pip <span class=\"token function\">install</span> MAnorm2_utils</code></pre></div>\n<h2>2. Prepare Input Table</h2>\n<p>MAnorm2<em>utils is working as a \"data-preparation\" too, which tool reads (bam converted bed file), peaks (from MACS</em>1.4.2)  and summit (from MACS_1.4.2 as well). Not easy to prepare...</p>\n<h3>2.1 BED format peak files</h3>\n<p>Honestly, MACS_1.4.2 version nearly died out, that I can't find much information about it. By reading <a href=\"https://groups.google.com/g/macs-announcement/c/2ARZwLHzI28\">this post</a>, I know that MACS2 is no longer generate bed file for narrow peak calling, instead it will return .narrowPeakl file. Also, by downloading origin version of MACS1.4.2, and check the README file, I found the definition of the 5th column in origin bed file:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">2</span>. NAME_peaks.bed is BED <span class=\"token function\">format</span> <span class=\"token function\">file</span> <span class=\"token function\">which</span> contains the peak\n locations. You can load it to UCSC genome browser or Affymetrix IGB\n software. The 5th <span class=\"token function\">column</span> <span class=\"token keyword\">in</span> this <span class=\"token function\">file</span> is the -10*log10pvalue of peak\n region.</code></pre></div>\n<p>Finally, by reading <a href=\"https://hbctraining.github.io/Intro-to-ChIPseq/lessons/05_peak_calling_macs.html\">this post</a>, I know that in narrowPeak file, the 8th column is the 10*log10pvalue. So it means I just need to extract the column [1, 2, 3, 4, 8] from my narrowPeak files (generated by MACS2), then it should works for MAnorm2.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># This is a script to convert MACS2 narrowPeak files to MACS1.4.2 bed file</span>\n<span class=\"token comment\"># Author: Tian</span>\n\nfiles <span class=\"token operator\">&lt;</span>- dir<span class=\"token punctuation\">(</span><span class=\"token string\">\"../14.PeakCalling/macs2_strict/\"</span>, <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"*.narrowPeak\"</span>, full.names<span class=\"token operator\">=</span>T<span class=\"token punctuation\">)</span>\nfile_names <span class=\"token operator\">&lt;</span>- dir<span class=\"token punctuation\">(</span><span class=\"token string\">\"../14.PeakCalling/macs2_strict/\"</span>, <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"*.narrowPeak\"</span><span class=\"token punctuation\">)</span>\nfile_names <span class=\"token operator\">&lt;</span>- as.vector<span class=\"token punctuation\">(</span>sapply<span class=\"token punctuation\">(</span>file_names, function<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> strsplit<span class=\"token punctuation\">(</span>x, <span class=\"token assign-left variable\">split</span><span class=\"token operator\">=</span><span class=\"token string\">\"_peaks\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">))</span>\n\nbaseDir <span class=\"token operator\">&lt;</span>- <span class=\"token string\">\"./bed/\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">))</span> dir.create<span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">)</span>\n\nfor<span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> <span class=\"token number\">1</span>:length<span class=\"token punctuation\">(</span>files<span class=\"token punctuation\">))</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">df</span> <span class=\"token operator\">&lt;</span>- read.csv<span class=\"token punctuation\">(</span>files<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>, <span class=\"token assign-left variable\">sep</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token entity\" title=\"\\t\">\\t</span>\"</span>, <span class=\"token assign-left variable\">header</span><span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n    write.table<span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">[</span>,c<span class=\"token punctuation\">(</span><span class=\"token number\">1,2</span>,3,4,8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span>paste0<span class=\"token punctuation\">(</span>baseDir, file_names<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>, <span class=\"token string\">'_peaks.bed'</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">quote</span><span class=\"token operator\">=</span>F, row.names<span class=\"token operator\">=</span>F, col.names<span class=\"token operator\">=</span>F, <span class=\"token assign-left variable\">sep</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token entity\" title=\"\\t\">\\t</span>\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token operator\">></span> head<span class=\"token punctuation\">(</span>narrowPeak_file_from_MACS2<span class=\"token punctuation\">)</span>\n    V1     V2     V3              V4 V5 V6      V7       V8      V9 V10\n<span class=\"token number\">1</span> chr1  <span class=\"token number\">29927</span>  <span class=\"token number\">30204</span> TC53_bnd_peak_1 <span class=\"token number\">88</span>  . <span class=\"token number\">7.59360</span> <span class=\"token number\">11.74890</span> <span class=\"token number\">8.88844</span> <span class=\"token number\">149</span>\n<span class=\"token number\">2</span> chr1 <span class=\"token number\">180061</span> <span class=\"token number\">180296</span> TC53_bnd_peak_2 <span class=\"token number\">45</span>  . <span class=\"token number\">5.14796</span>  <span class=\"token number\">6.98471</span> <span class=\"token number\">4.57548</span>  <span class=\"token number\">23</span>\n<span class=\"token number\">3</span> chr1 <span class=\"token number\">196305</span> <span class=\"token number\">196540</span> TC53_bnd_peak_3 <span class=\"token number\">36</span>  . <span class=\"token number\">4.57597</span>  <span class=\"token number\">5.90069</span> <span class=\"token number\">3.62210</span> <span class=\"token number\">187</span>\n<span class=\"token number\">4</span> chr1 <span class=\"token number\">200355</span> <span class=\"token number\">200688</span> TC53_bnd_peak_4 <span class=\"token number\">83</span>  . <span class=\"token number\">6.40890</span> <span class=\"token number\">11.12940</span> <span class=\"token number\">8.31881</span> <span class=\"token number\">199</span>\n<span class=\"token number\">5</span> chr1 <span class=\"token number\">201337</span> <span class=\"token number\">201572</span> TC53_bnd_peak_5 <span class=\"token number\">49</span>  . <span class=\"token number\">5.45709</span>  <span class=\"token number\">7.43798</span> <span class=\"token number\">4.99346</span> <span class=\"token number\">118</span>\n<span class=\"token number\">6</span> chr1 <span class=\"token number\">806028</span> <span class=\"token number\">806263</span> TC53_bnd_peak_6 <span class=\"token number\">34</span>  . <span class=\"token number\">4.47944</span>  <span class=\"token number\">5.66349</span> <span class=\"token number\">3.42953</span> <span class=\"token number\">130</span>\n<span class=\"token operator\">></span> \n<span class=\"token operator\">></span> head<span class=\"token punctuation\">(</span>converted_bed_file_for_MAnorm2<span class=\"token punctuation\">)</span>\n    V1     V2     V3              V4       V8\n<span class=\"token number\">1</span> chr1  <span class=\"token number\">29927</span>  <span class=\"token number\">30204</span> TC53_bnd_peak_1 <span class=\"token number\">11.74890</span>\n<span class=\"token number\">2</span> chr1 <span class=\"token number\">180061</span> <span class=\"token number\">180296</span> TC53_bnd_peak_2  <span class=\"token number\">6.98471</span>\n<span class=\"token number\">3</span> chr1 <span class=\"token number\">196305</span> <span class=\"token number\">196540</span> TC53_bnd_peak_3  <span class=\"token number\">5.90069</span>\n<span class=\"token number\">4</span> chr1 <span class=\"token number\">200355</span> <span class=\"token number\">200688</span> TC53_bnd_peak_4 <span class=\"token number\">11.12940</span>\n<span class=\"token number\">5</span> chr1 <span class=\"token number\">201337</span> <span class=\"token number\">201572</span> TC53_bnd_peak_5  <span class=\"token number\">7.43798</span>\n<span class=\"token number\">6</span> chr1 <span class=\"token number\">806028</span> <span class=\"token number\">806263</span> TC53_bnd_peak_6  <span class=\"token number\">5.66349</span>\n<span class=\"token operator\">></span></code></pre></div>\n<h3>2.2 Convert BAM files to reads.bed</h3>\n<p>Secondly, I need to convert the origin bam files into sam, then into reads, with <code class=\"language-text\">sam2bed</code> tool provided by MAnorm2_utils. Firstly I converted my bam files into sam.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">parallel --plus <span class=\"token string\">'samtools view -h {} -o {...}.sam'</span> ::: *.bam</code></pre></div>\n<p>Then, use the <code class=\"language-text\">sam2bed</code> as below:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">parallel --plus <span class=\"token string\">'sam2bed -i {} -o {...}.bed'</span> ::: *.sam</code></pre></div>\n<p>Now I have got the reads.bed for MAnorm2_utils input, an example is below:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">chr1    <span class=\"token number\">10908</span>   <span class=\"token number\">10944</span>   SRR871541.13121323  <span class=\"token number\">1</span>   +\nchr1    <span class=\"token number\">11236</span>   <span class=\"token number\">11272</span>   SRR871541.5778899   <span class=\"token number\">1</span>   +\nchr1    <span class=\"token number\">11328</span>   <span class=\"token number\">11364</span>   SRR871541.3338  <span class=\"token number\">1</span>   -\nchr1    <span class=\"token number\">11712</span>   <span class=\"token number\">11748</span>   SRR871541.8892517   <span class=\"token number\">1</span>   +\nchr1    <span class=\"token number\">11798</span>   <span class=\"token number\">11834</span>   SRR871541.5776278   <span class=\"token number\">1</span>   +\nchr1    <span class=\"token number\">11810</span>   <span class=\"token number\">11846</span>   SRR871541.3348  <span class=\"token number\">1</span>   -\nchr1    <span class=\"token number\">11832</span>   <span class=\"token number\">11868</span>   SRR871541.3349  <span class=\"token number\">1</span>   -\nchr1    <span class=\"token number\">11930</span>   <span class=\"token number\">11966</span>   SRR871541.3352  <span class=\"token number\">1</span>   -\nchr1    <span class=\"token number\">12012</span>   <span class=\"token number\">12048</span>   SRR871541.3355  <span class=\"token number\">1</span>   -\nchr1    <span class=\"token number\">12100</span>   <span class=\"token number\">12136</span>   SRR871541.3356  <span class=\"token number\">1</span>   -\nchr1    <span class=\"token number\">12225</span>   <span class=\"token number\">12261</span>   SRR871541.3358  <span class=\"token number\">1</span>   +</code></pre></div>\n<p>I noticed that seems Input.bed file is not used for MAnorm2 input, not sure why? I think they are important as control.</p>\n<h3>2.3 Create InputTable with profile_bins</h3>\n<p>Finally, I can run the <code class=\"language-text\">profile_bins</code> function, which should read in bam (have been converted into read.bed), peaks (narrowPeak converted bed), summit (generated by MACS2) to generate a table for MAnorm2.</p>\n<p>I formed a file called <code class=\"language-text\">param</code>, added information of my files, which listed my peaks, reads, labs, summits. And the result name is \"prepared\". In my case, the files are single-end sequenced.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">peaks</span><span class=\"token operator\">=</span>./bed//LT49_bnd_peaks.bed,./bed//LT51_bnd_peaks.bed,./bed//LT52_bnd_peaks.bed,./bed//LT53_bnd_peaks.bed,./bed//LT55_bnd_peaks.bed,./bed//NC24_Bnd_Away_peaks.bed,./bed//NC24_Bnd_peaks.bed,./bed//NC35_Bnd_peaks.bed,./bed//NC37_Bnd_peaks.bed,./bed//NC42_Bnd_peaks.bed,./bed//NC44_Bnd_peaks.bed,./bed//NC49_bnd_peaks.bed,./bed//NC51_bnd_peaks.bed,./bed//NC52_bnd_peaks.bed,./bed//NC53_bnd_peaks.bed,./bed//NL49_bnd_peaks.bed,./bed//NL51_bnd_peaks.bed,./bed//NL52_bnd_peaks.bed,./bed//NL53_bnd_peaks.bed,./bed//NL55_bnd_peaks.bed,./bed//TC24_Bnd_peaks.bed,./bed//TC35_Bnd_peaks.bed,./bed//TC42_Bnd_peaks.bed,./bed//TC44_Bnd_peaks.bed,./bed//TC49_bnd_peaks.bed,./bed//TC51_bnd_peaks.bed,./bed//TC52_bnd_peaks.bed,./bed//TC53_bnd_peaks.bed\n<span class=\"token assign-left variable\">reads</span><span class=\"token operator\">=</span>./sam//LT49_bnd.bed,./sam//LT51_bnd.bed,./sam//LT52_bnd.bed,./sam//LT53_bnd.bed,./sam//LT55_bnd.bed,./sam//NC24_Bnd_Away.bed,./sam//NC24_Bnd.bed,./sam//NC35_Bnd.bed,./sam//NC37_Bnd.bed,./sam//NC42_Bnd.bed,./sam//NC44_Bnd.bed,./sam//NC49_bnd.bed,./sam//NC51_bnd.bed,./sam//NC52_bnd.bed,./sam//NC53_bnd.bed,./sam//NL49_bnd.bed,./sam//NL51_bnd.bed,./sam//NL52_bnd.bed,./sam//NL53_bnd.bed,./sam//NL55_bnd.bed,./sam//TC24_Bnd.bed,./sam//TC35_Bnd.bed,./sam//TC42_Bnd.bed,./sam//TC44_Bnd.bed,./sam//TC49_bnd.bed,./sam//TC51_bnd.bed,./sam//TC52_bnd.bed,./sam//TC53_bnd.bed\n<span class=\"token assign-left variable\">labs</span><span class=\"token operator\">=</span>LT49_bnd,LT51_bnd,LT52_bnd,LT53_bnd,LT55_bnd,NC24_Bnd_Away,NC24_Bnd,NC35_Bnd,NC37_Bnd,NC42_Bnd,NC44_Bnd,NC49_bnd,NC51_bnd,NC52_bnd,NC53_bnd,NL49_bnd,NL51_bnd,NL52_bnd,NL53_bnd,NL55_bnd,TC24_Bnd,TC35_Bnd,TC42_Bnd,TC44_Bnd,TC49_bnd,TC51_bnd,TC52_bnd,TC53_bnd\n<span class=\"token assign-left variable\">n</span><span class=\"token operator\">=</span>prepared\n<span class=\"token assign-left variable\">summits</span><span class=\"token operator\">=</span>./summit//LT49_bnd_summits.bed,./summit//LT51_bnd_summits.bed,./summit//LT52_bnd_summits.bed,./summit//LT53_bnd_summits.bed,./summit//LT55_bnd_summits.bed,./summit//NC24_Bnd_Away_summits.bed,./summit//NC24_Bnd_summits.bed,./summit//NC35_Bnd_summits.bed,./summit//NC37_Bnd_summits.bed,./summit//NC42_Bnd_summits.bed,./summit//NC44_Bnd_summits.bed,./summit//NC49_bnd_summits.bed,./summit//NC51_bnd_summits.bed,./summit//NC52_bnd_summits.bed,./summit//NC53_bnd_summits.bed,./summit//NL49_bnd_summits.bed,./summit//NL51_bnd_summits.bed,./summit//NL52_bnd_summits.bed,./summit//NL53_bnd_summits.bed,./summit//NL55_bnd_summits.bed,./summit//TC24_Bnd_summits.bed,./summit//TC35_Bnd_summits.bed,./summit//TC42_Bnd_summits.bed,./summit//TC44_Bnd_summits.bed,./summit//TC49_bnd_summits.bed,./summit//TC51_bnd_summits.bed,./summit//TC52_bnd_summits.bed,./summit//TC53_bnd_summits.bed\nkeep-dup<span class=\"token operator\">=</span><span class=\"token number\">1</span></code></pre></div>\n<p>Finally, below command worked</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">profile_bins --parameters<span class=\"token operator\">=</span>./param</code></pre></div>\n<p>The <code class=\"language-text\">prepared_profile_bins.xls</code> file is what I need for MAnorm2 import.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/29631942ffa35d92779c3f0d9266123b/1134b/figure1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACMElEQVQ4y5WSy27TQBSG/WY8B1seAbxgwx5UcQlBiIvUKo0roBtoIUUqUqQgkYYmyoaLHJI0cZPYtWd8SXyL7SSHM9OO5UpsGOnX73PmzOffF6n0fufm86O9g9JhZffF5zdKuVZVHh1sKw8/bHN/fLijvDp+p7z+sq+Uj6pK6VNFeVrb5f7kI4p5rVJF7b88frsl/VZ/lAEXcSj4kQ+LYA7uwgWTmmDPHbCwz3pBFECUxuC6FAxKgHgu3/f8OVAPZ5IYzvXpTDI09UEW2+BYWkwvRplHNNQkc8k5l21ql9cWOp1gPc7M2TCb29PMd/Us9IwscGdJ7BNwiP5LOjsbbvGExEpN0wTHccC2ae4U0zARQsCyTO62jQGcS1FKWb0OwwDwvCqNRiMOnE6nqWVZEMcx+L4PYRRxZ1osmBbgeR73MAwhwv3oagbrNS62p0r9/h8OnEwmPOFyucwPBEFwTQzGAAImZuI4Wm82G7anSoPBIE/IgEmSXBsuphFgUbOnuarXjMGBvV6PA8fjcarrOgcWE4qDzFmfSdSiJ4D8kUVCBjQMI09YuHteF4FCxYQcKBIOh0MG3CBwgwNcOJw7griLHsKKM8WP0r/PgNpYi/AdplmWpTjMhRDu+KG48CCX6OHNeY3XyWq1Yu/wJ0v4jAEviIW/Sgj/u9jXFQv/R0P62mjcaLZO7n37fnL7tH0qd9ptudPpyG30f0nsdbtduV6vy41GQ261WneazeZd1K2/8XmurfiifZEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"profile_bin_xlsx\"\n        title=\"profile_bin_xlsx\"\n        src=\"/static/29631942ffa35d92779c3f0d9266123b/00d43/figure1.png\"\n        srcset=\"/static/29631942ffa35d92779c3f0d9266123b/63868/figure1.png 250w,\n/static/29631942ffa35d92779c3f0d9266123b/0b533/figure1.png 500w,\n/static/29631942ffa35d92779c3f0d9266123b/00d43/figure1.png 1000w,\n/static/29631942ffa35d92779c3f0d9266123b/1134b/figure1.png 1470w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","frontmatter":{"date":"August 03, 2021","slug":"/notes/MAnorm2-analysis-on-hMeDIP-seq-data","title":"MAnorm2 analysis on hMeDIP-seq 1: Preparation","tags":["MAnorm2","MeDIP-seq","Preprocess"],"abstract":"After working on QSEA and DiffBind, now I want to try the last solution - MAnorm2 for my hMeDIP-seq data. Out of my expectation, it is a bit hard indeed to run it, and this is the first half of my record, which is about preparation of with MAnorm2_utils."}}},"pageContext":{"slug":"/notes/MAnorm2-analysis-on-hMeDIP-seq-data"}}}