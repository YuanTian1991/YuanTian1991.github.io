{
    "componentChunkName": "component---src-templates-note-template-js",
    "path": "/notes/My-ChIP-Seq-Preprocess-Pipeline",
    "result": {"data":{"markdownRemark":{"html":"<p>ChIP-seq is a technical to use anti-body to pull down target genome segments then use high-throughput sequencing to analysis attached location of these segments (reads). I started to work on it since April last year and now it's time to write it up. In this note I record a bit the preprocessing steps for the ChIP-seq data. Mere, it includes:</p>\n<ol start=\"0\">\n<li>Input Requirement</li>\n<li>Quality Control with fastQC/multiQC</li>\n<li>Adapter Trimming</li>\n<li>Alignment</li>\n<li>GreyList Removing</li>\n<li>BigWig Generation (optional)</li>\n<li>Peak Calling</li>\n</ol>\n<p>Note that I chained them up with a single one R script.</p>\n<h2>0. Input Requirement</h2>\n<p>Fistly I am here to specify input requirement. Just three things:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">fqDir <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"../S01_RawFastQ/5hmC\"</span>\nSampleSheet <span class=\"token operator\">&lt;-</span> read.csv<span class=\"token punctuation\">(</span><span class=\"token string\">\"../S01_RawFastQ/5hmC/5hmC_Sample_Table.csv\"</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\noutputPrefix <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"./result\"</span></code></pre></div>\n<p>fqDir is where raw fastQC will be. No matter it's downloaded from SRA or generated by some companies. outputPrefix is a target folder.</p>\n<p>SampleSheet is looks like blow. Below are minium requirement for sample sheet. Type indicate if this FQ file is Bound or Input control. SampleName must be unique, fqFiles are paths to FQ files. And phred indicate if this file is using old style 64 format, or recent 33 format. I know the phred value by checking the first step (fastQC report), it will be used in the second step fastp trimming.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token operator\">></span> knitr<span class=\"token operator\">::</span>kable<span class=\"token punctuation\">(</span>head<span class=\"token punctuation\">(</span>SampleSheet<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SampleName\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"fqFiles\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"phred\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">|</span>Type <span class=\"token operator\">|</span>SampleName <span class=\"token operator\">|</span>fqFiles                                                          <span class=\"token operator\">|</span>phred <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span><span class=\"token operator\">:</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">|</span><span class=\"token operator\">:</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">|</span><span class=\"token operator\">:</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">|</span><span class=\"token operator\">:</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>Bnd  <span class=\"token operator\">|</span>NC42_Bnd   <span class=\"token operator\">|</span><span class=\"token operator\">/</span>mnt<span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>CRC_Paper<span class=\"token operator\">/</span>S01_RawFastQ<span class=\"token operator\">/</span><span class=\"token number\">5</span>hmC<span class=\"token operator\">/</span><span class=\"token operator\">/</span>SRR871537_1.fastq.gz <span class=\"token operator\">|</span><span class=\"token boolean\">FALSE</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>Inp  <span class=\"token operator\">|</span>NC24_Inp   <span class=\"token operator\">|</span><span class=\"token operator\">/</span>mnt<span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>CRC_Paper<span class=\"token operator\">/</span>S01_RawFastQ<span class=\"token operator\">/</span><span class=\"token number\">5</span>hmC<span class=\"token operator\">/</span><span class=\"token operator\">/</span>SRR871539_1.fastq.gz <span class=\"token operator\">|</span><span class=\"token boolean\">FALSE</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>Bnd  <span class=\"token operator\">|</span>NC44_Bnd   <span class=\"token operator\">|</span><span class=\"token operator\">/</span>mnt<span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>CRC_Paper<span class=\"token operator\">/</span>S01_RawFastQ<span class=\"token operator\">/</span><span class=\"token number\">5</span>hmC<span class=\"token operator\">/</span><span class=\"token operator\">/</span>SRR871541_1.fastq.gz <span class=\"token operator\">|</span><span class=\"token boolean\">FALSE</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>Inp  <span class=\"token operator\">|</span>NC35_Inp   <span class=\"token operator\">|</span><span class=\"token operator\">/</span>mnt<span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>CRC_Paper<span class=\"token operator\">/</span>S01_RawFastQ<span class=\"token operator\">/</span><span class=\"token number\">5</span>hmC<span class=\"token operator\">/</span><span class=\"token operator\">/</span>SRR871543_1.fastq.gz <span class=\"token operator\">|</span><span class=\"token boolean\">FALSE</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>Bnd  <span class=\"token operator\">|</span>TC24_Bnd   <span class=\"token operator\">|</span><span class=\"token operator\">/</span>mnt<span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>CRC_Paper<span class=\"token operator\">/</span>S01_RawFastQ<span class=\"token operator\">/</span><span class=\"token number\">5</span>hmC<span class=\"token operator\">/</span><span class=\"token operator\">/</span>SRR871544_1.fastq.gz <span class=\"token operator\">|</span><span class=\"token boolean\">FALSE</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>Bnd  <span class=\"token operator\">|</span>TC35_Bnd   <span class=\"token operator\">|</span><span class=\"token operator\">/</span>mnt<span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>Tian<span class=\"token operator\">/</span>CRC_Paper<span class=\"token operator\">/</span>S01_RawFastQ<span class=\"token operator\">/</span><span class=\"token number\">5</span>hmC<span class=\"token operator\">/</span><span class=\"token operator\">/</span>SRR871546_1.fastq.gz <span class=\"token operator\">|</span><span class=\"token boolean\">FALSE</span> <span class=\"token operator\">|</span></code></pre></div>\n<h2>1. Quality Control with fastQC/multiQC</h2>\n<p>This is quite standard, use fastQC to check low quality samples. I am using <a href=\"https://cran.r-project.org/web/packages/fastqcr/index.html\">fastqcr R package</a>, basically the uage is 100% similar to the comand line tool.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># These command create a folder for fastQC result</span>\nmessage<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nRun FastQC...\"</span><span class=\"token punctuation\">)</span>\nfileFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/fastQC\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Below is the key command</span>\nmyFastQC <span class=\"token operator\">&lt;-</span> fastqc<span class=\"token punctuation\">(</span>fq.dir <span class=\"token operator\">=</span> fqDir<span class=\"token punctuation\">,</span> qc.dir <span class=\"token operator\">=</span> fileFolder<span class=\"token punctuation\">,</span> fastqc.path<span class=\"token operator\">=</span><span class=\"token string\">\"/usr/bin/fastqc\"</span><span class=\"token punctuation\">,</span> threads <span class=\"token operator\">=</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>After running (3-4 mins), the fastQC HTML files will be in the corresponding folders. Then a simple <code class=\"language-text\">multiqc ./result/fastQC</code> command could create multiQC report.</p>\n<h2>2. Adapter Trimming</h2>\n<p>Adapter trimming is the first step for most sequencing data. Here I am using <a href=\"https://github.com/OpenGene/fastp\">fastp</a>, a very fast trimming tool, and it can automatically decide the adapter so I don't need to findout what the adapter is. Also I am using the R version of fastp, <a href=\"http://www.bioconductor.org/packages/release/bioc/html/Rfastp.html\">Rfastp</a> , here.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">message<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nRunning RFastp in parallel...(Roughly one min for one sample)\"</span><span class=\"token punctuation\">)</span>\nfileFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/fastp\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">)</span>\n\nlibrary<span class=\"token punctuation\">(</span>doParallel<span class=\"token punctuation\">)</span>\ndetectCores<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ncl <span class=\"token operator\">&lt;-</span> makeCluster<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\nregisterDoParallel<span class=\"token punctuation\">(</span>cl<span class=\"token punctuation\">)</span>\ngetDoParWorkers<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nlibrary<span class=\"token punctuation\">(</span>foreach<span class=\"token punctuation\">)</span>\nmyFastp <span class=\"token operator\">&lt;-</span> foreach<span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span>nrow<span class=\"token punctuation\">(</span>SampleSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> .packages<span class=\"token operator\">=</span><span class=\"token string\">'Rfastp'</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%dopar%</span> <span class=\"token punctuation\">{</span>\n    rfastp<span class=\"token punctuation\">(</span>read1 <span class=\"token operator\">=</span> SampleSheet<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">,</span> <span class=\"token string\">\"fqFiles\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> outputFastq <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> SampleSheet<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">,</span> <span class=\"token string\">\"SampleName\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> phred64<span class=\"token operator\">=</span>SampleSheet<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">,</span> <span class=\"token string\">\"phred\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nregisterDoSEQ<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\non.exit<span class=\"token punctuation\">(</span>stopCluster<span class=\"token punctuation\">(</span>cl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nfastpFolder <span class=\"token operator\">&lt;-</span> fileFolder</code></pre></div>\n<p>Here I am still using <code class=\"language-text\">doParallel</code> for R parallel running, but in the future I will mostly use <code class=\"language-text\">mclapply</code>.</p>\n<h2>3. Alignment</h2>\n<p>Alignment is one of the most important step for sequencing analysis, here firstly I need to select the most proper software and corresponding genome reference. In here I will use <a href=\"http://bowtie-bio.sourceforge.net/bowtie2/index.shtml\">bowtie2</a> for alignment, which is not too slow for ChIP-seq, and the reference <strong>GRCh38_noalt_as</strong> is directly downloaded from bowtie2 website. It need to be download to local folder, in my case, I put it in the analysis folder. Then below is the code. I am just using the R to excute a bash command...Not a clever way.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">message<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nRun Rbowtie2 in parallel...\"</span><span class=\"token punctuation\">)</span>\nfileFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/bowtie2\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>fileFolder<span class=\"token punctuation\">)</span>\n\nmyBowtie2 <span class=\"token operator\">&lt;-</span> list<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span>nrow<span class=\"token punctuation\">(</span>SampleSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    cmd <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"bowtie2 -p 30 -q --local -x ./GRCh38_noalt_as/GRCh38_noalt_as -U {fastpFolder}/{SampleSheet[i, 'SampleName']}_R1.fastq.gz | samtools view -bS - > {fileFolder}/{SampleSheet[i, 'SampleName']}.bam\"</span><span class=\"token punctuation\">)</span>\n    message<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n    system<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\nbowtie2Folder <span class=\"token operator\">&lt;-</span> fileFolder</code></pre></div>\n<h2>4. GreyList Removing</h2>\n<p>After mapping, I can get BAM files for each sample, however, if I convert these BAM files to bigwig for visualisation, I can hardly see any pattern, because there are some regions in genome would capture a lot of reads. These regions are called black/grey regions, these list can be download from pre-generated list like <a href=\"https://github.com/Boyle-Lab/Blacklist/tree/master/lists\">this</a> or <a href=\"https://www.encodeproject.org/files/ENCFF356LFX/\">here</a>. Or use some packages to generate from your Input samples. Here I am using <a href=\"https://www.bioconductor.org/packages/devel/bioc/html/GreyListChIP.html\">GreyListChIP</a> to generate the greylist from all my Input samples.</p>\n<p>In below script, I used mclappy to calculate greylist for each Input sample, and put them in the <code class=\"language-text\">greylist</code> folder.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">message<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nRemove GreyList\"</span><span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreyListChIP\"</span><span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">\"BSgenome.Hsapiens.UCSC.hg38\"</span><span class=\"token punctuation\">)</span>\n\ngreylistFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/greylist\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>greylistFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>greylistFolder<span class=\"token punctuation\">)</span>\n\ngetGreyList <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> bowtie2Folder<span class=\"token punctuation\">,</span> targetFolder<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">(</span><span class=\"token string\">\"Generating greylist for \"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span>\n    message<span class=\"token punctuation\">(</span>glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{targetFolder}/{i}_GreyList.bed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    tmpGreyList <span class=\"token operator\">&lt;-</span> greyListBS<span class=\"token punctuation\">(</span>BSgenome.Hsapiens.UCSC.hg38<span class=\"token punctuation\">,</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{bowtie2Folder}/{i}.bam\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    export<span class=\"token punctuation\">(</span>tmpGreyList<span class=\"token punctuation\">,</span> con<span class=\"token operator\">=</span>glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{targetFolder}/{i}_GreyList.bed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nInps <span class=\"token operator\">&lt;-</span> SampleSheet<span class=\"token operator\">$</span>SampleName<span class=\"token punctuation\">[</span>SampleSheet<span class=\"token operator\">$</span>Type <span class=\"token operator\">==</span> <span class=\"token string\">\"Inp\"</span><span class=\"token punctuation\">]</span>\nmyGreyList <span class=\"token operator\">&lt;-</span> mclapply<span class=\"token punctuation\">(</span>Inps<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> getGreyList<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> bowtie2Folder<span class=\"token punctuation\">,</span> greylistFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mc.cores <span class=\"token operator\">=</span> length<span class=\"token punctuation\">(</span>Inps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>After identification of grey regions, we then need to remove these regions from all sample's bam files. In below script, I firstly megred all Input greylist into a <code class=\"language-text\">MergedGreyList.bed</code>. Then <a href=\"https://bedtools.readthedocs.io/en/latest/\">bedtools</a> is used here to remove pre-generated greylist. Note that here I am using <a href=\"https://www.gnu.org/software/parallel/\">parallel</a>, which is a nice tool for parallel running in linux (not R).</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">message<span class=\"token punctuation\">(</span><span class=\"token string\">\"Filter BAM files\"</span><span class=\"token punctuation\">)</span>\nfilteredBamFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/filteredBam\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>filteredBamFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>filteredBamFolder<span class=\"token punctuation\">)</span>\n\ncmd <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"cat {greylistFolder}/* > ./MergedGreyList.bed\"</span><span class=\"token punctuation\">)</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\ncmd <span class=\"token operator\">&lt;-</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"parallel --plus 'bedtools intersect -v -abam {} -b ./MergedGreyList.bed > \"</span><span class=\"token punctuation\">,</span> filteredBamFolder<span class=\"token punctuation\">,</span><span class=\"token string\">\"/{/.}.grey_filtered.bam' ::: \"</span><span class=\"token punctuation\">,</span> bowtie2Folder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/*.bam\"</span><span class=\"token punctuation\">)</span>\nmessage<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span></code></pre></div>\n<p>After this step, we can BAM files that we can use in many downstream analysis, like Peak Calling .etc. However, in many cases, these BAM files need to be preprocess a bit, like sorted and index.</p>\n<h2>5. BigWig Generation (optional)</h2>\n<p>BigWig is a format suitable for IGV visualisation. The BigWig can be generated from BAM, which can be see as a \"summary\" of all reads. In below 3 parallel commands, it will sort, index and created bigwig files for each sample.</p>\n<p><b style=\"background-color: yellow\">These sorted and indexed BAM files should be used for all downstream analysis.</b></p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">message<span class=\"token punctuation\">(</span><span class=\"token string\">\"Sort, Index and BigWig Generation\"</span><span class=\"token punctuation\">)</span>\nsortedBamFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/sortedBam\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>sortedBamFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>sortedBamFolder<span class=\"token punctuation\">)</span>\n\nmessage<span class=\"token punctuation\">(</span><span class=\"token string\">\"Sorting blacklist filtered bam files...\"</span><span class=\"token punctuation\">)</span>\ncmd <span class=\"token operator\">&lt;-</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"parallel --plus 'samtools sort {} -o \"</span><span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/{/.}.sorted.bam' ::: \"</span><span class=\"token punctuation\">,</span> filteredBamFolder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/*.grey_filtered.bam\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># cmd &lt;- \"parallel --plus 'samtools sort {} -o ./myBigWig/{/.}.sorted.bam' ::: ./myAlignment/*.bam\"</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\ncmd <span class=\"token operator\">&lt;-</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"parallel --plus 'samtools index {} \"</span><span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span><span class=\"token string\">\"/{/..}.sorted.bam.bai' ::: \"</span><span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/*.bam\"</span><span class=\"token punctuation\">)</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\ncmd <span class=\"token operator\">&lt;-</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"parallel --plus 'bamCoverage -p 5 -b {} -o \"</span><span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/{/.}.bw' ::: \"</span><span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/*.sorted.bam\"</span><span class=\"token punctuation\">)</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span></code></pre></div>\n<p>These bigwig files can be viewered with IGV conviniently. Note that the peaks on the plot is NOT reliable at all for any analysis, it will just do scalling for each sample. Maybe Group Scale could help a little bit. However, in <a href=\"https://yuantian1991.github.io/notes/Bias-in-ChIP-seq-visualisation\">my post here</a>, I described how I use IGV to visualise normalised data.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2e38d08e22699e6fe8f99606a8f32ed0/33d1d/figure1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACaUlEQVQoz3WS20/iUBDG+cNNfPASIxqNiBiighcQUW4KBrxg1pj4oA8acKMIcumVtqBsS1sK+m3OVNmnfZiemTnfmfM7M/UMBgM4jgPTNKHrOgYDB7Y9IGN7P/7/zLLssbE6HvYZjUbo9w18fLzDcdimCdu2vlcTltUfr6ZpkDG96+vQ9Q/oeo/OeDRNg6qqkGUFpZKCu7s2Hh4UsnJZxeMjy8m4v3fzt7eu//SkkrZYFHBzI6JUUtHr9d2CmqZCFBVkswICgTeEww3s7TWRSgmIxTiEQg2ySKQFn6+G9fU3pNMC5aamnjE/X0E02oIg9OFRFBWqqkAU24jFmpic/A2v9wWLixVsbtbh91fJX1ioIBh8w+wsK/CCUKiOQKCG6elnzM29YGenAZ434Ol2u+h2O5BlFYlEi25bWnqFz1fF7m4Ta2s1iv1+Rlajw15vBZFIk0gnJp4wM/OMlZUqyuV3eGRZRqejQZIU/PolIZMRkMnwyOclXF+3cXEh4/RUpDibFYkkmeRp7/hYwMZGnWjPziRomskKtqmHPC8jn+eJKhZrIZ3mScQOxeMcjo44HB5yRMn6y/b291tEy15wciJAUUx4Op3OmLBQELC15Q7k4KBFokSCQzTqXsKeubpapaExapZnvV1efiVqQTD+DYXnJVxeijQtRsImXizKyOVEJBI8TTWV4mlQjPjqqk061mtmrB2K8v3bsKFoWhfn5yK2txtEE4+7hMkkR2QsTqU4hMN1igsFieiDwRr1NZcTfggV9Ho9GIaB4dAEYOPry8bnJzOL/NHIguMYsO0/GA6NcY5pfvSuxsZfeZs8Zdr1twgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IGV view on Bigwig\"\n        title=\"IGV view on Bigwig\"\n        src=\"/static/2e38d08e22699e6fe8f99606a8f32ed0/00d43/figure1.png\"\n        srcset=\"/static/2e38d08e22699e6fe8f99606a8f32ed0/63868/figure1.png 250w,\n/static/2e38d08e22699e6fe8f99606a8f32ed0/0b533/figure1.png 500w,\n/static/2e38d08e22699e6fe8f99606a8f32ed0/00d43/figure1.png 1000w,\n/static/2e38d08e22699e6fe8f99606a8f32ed0/33d1d/figure1.png 1150w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>6. Peak Calling</h2>\n<p>Finally, a normal step is to do peak calling, there are many software for this. MACS2, SICER and many more, but also according to paper comparison, most peak calling software return similar results. Here I am using MACS2, because most downstream analysis software support it.</p>\n<p>In my analysis, since not all my Bound file have corresponding Input control, so I merged all Input togather as below:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">cmd <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"samtools merge MergedInput.bam `ls {sortedBamFolder}/*_Inp.grey_filtered.sorted.bam`\"</span><span class=\"token punctuation\">)</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Also, this merged Input file need to be sorted for peak calling usage.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">cmd <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"samtools sort ./MergedInput.bam -o ./MergedInput.sorted.bam ; samtools index ./MergedInput.sorted.bam ./MergedInput.sorted.bam.bai\"</span>\nsystem<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Then below command could be run to return narrowPeaks.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">macs2NarrowPeaksFolder  <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"{outputPrefix}/macs2NarrowPeaks\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file.exists<span class=\"token punctuation\">(</span>macs2NarrowPeaksFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> dir.create<span class=\"token punctuation\">(</span>macs2NarrowPeaksFolder<span class=\"token punctuation\">)</span>\n\nrunMACS2 <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span> macs2NarrowPeaksFolder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">(</span><span class=\"token string\">\"Running MACS2 NarrowPeak for \"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span>\n    cmd <span class=\"token operator\">&lt;-</span> glue<span class=\"token punctuation\">(</span><span class=\"token string\">\"macs2 callpeak -t {sortedBamFolder}/{i}.grey_filtered.sorted.bam -c ./MergedInput.sorted.bam -f BAM -g 3.0e9 --outdir {macs2NarrowPeaksFolder} -n {i} -B --tempdir ./myTMP -q 0.05 2> {macs2NarrowPeaksFolder}/{i}-macs2.  log\"</span><span class=\"token punctuation\">)</span>\n    message<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n    system<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nBnds <span class=\"token operator\">&lt;-</span> SampleSheet<span class=\"token operator\">$</span>SampleName<span class=\"token punctuation\">[</span>SampleSheet<span class=\"token operator\">$</span>Type <span class=\"token operator\">!=</span> <span class=\"token string\">\"Inp\"</span><span class=\"token punctuation\">]</span>\nmyMacs2NarrowPeaks <span class=\"token operator\">&lt;-</span> mclapply<span class=\"token punctuation\">(</span>Bnds<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> runMACS2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> sortedBamFolder<span class=\"token punctuation\">,</span> macs2NarrowPeaksFolder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mc.cores <span class=\"token operator\">=</span> length<span class=\"token punctuation\">(</span>Bnds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>After MACS2, I can get narrowPeak for downstream anlaysis, for example I recommand to use <a href=\"https://yuantian1991.github.io/notes/MAnorm2-package-for-hMeDIP-seq-2:-Normalisation-&#x26;-Analysis\">MAnorm2</a> for downstream analysis.</p>","frontmatter":{"date":"February 28, 2022","slug":"/notes/My-ChIP-Seq-Preprocess-Pipeline","title":"My ChIP-Seq Preprocess Pipeline","tags":["ChIP-Seq","Pipeline"],"abstract":"I am now organising code for ChIP-seq paper, so I record a bit the preprocessing steps for future usage."}}},"pageContext":{"slug":"/notes/My-ChIP-Seq-Preprocess-Pipeline"}},
    "staticQueryHashes": ["63159454"]}